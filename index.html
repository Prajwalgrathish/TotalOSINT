<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TotalOSINT</title>
    <!-- Original Long Description -->
    <meta name="description" content="TotalOSINT is a privacy-first, client-side OSINT toolkit for security analysts. Instantly extract IOCs (IPs, Domains, Hashes) from raw logs and launch bulk investigations across dozens of threat intelligence sources. Zero-data-persistence workflow for SOC and DFIR teams. No installation required.">
    <meta name="keywords" content="osint, threat-intelligence, cybersecurity, soc, blue-team, incident-response, investigation, ioc-extraction, dfir, opsec, malware-analysis, security-tools, productivity, javascript, infosec, digital-forensics, threat-hunting, ioc-parser, ip-lookup, hash-lookup, reconnaissance, privacy-focused, client-side, zero-persistence, secops">
    <!-- Open Graph / Social Sharing -->
    <meta property="og:title" content="TotalOSINT">
    <meta property="og:description" content="TotalOSINT is a privacy-first, client-side OSINT toolkit. Extract IOCs and launch investigations instantly.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jhatzimalis.github.io/TotalOSINT/">
        <meta property="og:image" content="https://jhatzimalis.github.io/TotalOSINT/social.png">
    <!-- Twitter Card Data -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TotalOSINT">
    <meta name="twitter:description" content="Privacy-first, client-side OSINT toolkit for security analysts.">
    <meta name="twitter:image" content="https://jhatzimalis.github.io/TotalOSINT/social.png">
    <!-- Favicon (Browser Tab - Emoji) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïµÔ∏è‚Äç‚ôÇÔ∏è</text></svg>">
    <!-- Apple Touch Icon (Optional: Create a square PNG named 'apple-touch-icon.png' for iOS home screen) -->
    <!-- <link rel="apple-touch-icon" href="apple-touch-icon.png"> -->

    <style>
        /* --- Variables --- */
        :root {
            --bg-body: #0f172a; --bg-panel: #1e293b; --bg-header: #020617;
            --text-main: #f1f5f9; --text-muted: #94a3b8; --text-light: #ecf0f1;
            --accent: #3b82f6; --accent-hover: #60a5fa; 
            --border: #334155; --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --radius: 6px;
            --hl-dim: rgba(255, 255, 255, 0.08); 
            --hl-active: rgba(59, 130, 246, 0.5); 
            --toast-y: 85px; 
        }

        body.theme-light {
            --bg-body: #f4f6f8; --bg-panel: #ffffff; --bg-header: #202b36;
            --text-main: #2c3e50; --text-muted: #64748b;
            --accent: #2563eb; --accent-hover: #1d4ed8; 
            --border: #dce1e6; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --hl-dim: rgba(0, 0, 0, 0.05); 
            --hl-active: rgba(255, 235, 59, 0.5);
        }

        /* --- Reset & Layout --- */
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-body); color: var(--text-main); margin: 0; 
            display: flex; flex-direction: column; 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
        }
        
        /* --- Navbar --- */
        header { background: var(--bg-header); color: var(--text-light); padding: 0 15px; height: 50px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; border-bottom: 1px solid #1e293b; z-index: 10; }
        .branding { display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
        .branding:hover { opacity: 0.9; }
        .logo-text { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
        .nav-links { display: flex; gap: 10px; align-items: center; }
        .nav-link { color: var(--text-muted); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; display: flex; align-items: center; gap: 5px; }
        .nav-link:hover { color: var(--text-light); }
        
        .icon-btn { background: none; border: 1px solid transparent; color: inherit; font-size: 1.2rem; cursor: pointer; padding: 6px; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        /* --- Buttons --- */
        .btn-fancy {
            display: flex; align-items: stretch; padding: 0; border: 1px solid var(--border); border-radius: var(--radius);
            background: var(--bg-panel); color: var(--text-main); cursor: pointer; transition: all 0.1s; overflow: hidden; height: 36px;
            user-select: none; min-width: 0;
        }
        .btn-fancy:hover { border-color: var(--accent); transform: translateY(-1px); }
        .btn-fancy:active { transform: translateY(0); }
        
        .btn-fancy-icon { width: 34px; background: rgba(125,125,125,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; border-right: 1px solid var(--border); flex-shrink: 0; }
        .btn-fancy-text { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.85rem; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary .btn-fancy-icon { background: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.1); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-success .btn-fancy-icon { background: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.1); }
        
        .btn-sm { height: 28px; font-size: 0.8rem; }
        .btn-sm .btn-fancy-icon { width: 28px; font-size: 0.9rem; }
        
        /* Icon Only Button (Square) */
        .btn-square { width: 36px; padding: 0; justify-content: center; align-items: center; flex: 0 0 36px; }
        .btn-square.btn-sm { width: 28px; flex: 0 0 28px; }
        .btn-square .btn-fancy-icon { width: 100%; border: none; background: transparent; }

        /* --- Main Layout --- */
        main { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Left Panel */
        .panel-input { width: 400px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 5; flex-shrink: 0; }
        .panel-header { padding: 8px 12px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); }
        .header-actions { display: flex; gap: 5px; }

        .input-container { position: relative; flex: 1; width: 100%; overflow: hidden; background: var(--bg-panel); }
        .input-backdrop, .input-textarea {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; margin: 0; padding: 15px; border: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5;
            white-space: pre-wrap; word-wrap: break-word; overflow: auto;
            background: transparent;
        }
        .input-backdrop { z-index: 1; color: transparent; pointer-events: none; scrollbar-width: none; } 
        .input-backdrop::-webkit-scrollbar { display: none; }
        .input-textarea { z-index: 2; color: var(--text-main); resize: none; outline: none; }
        
        /* Highlights */
        mark { color: transparent; border-radius: 2px; background: transparent; }
        .mode-overview mark { background: var(--hl-active); }
        .mode-ip mark.type-ip { background: var(--hl-active); }
        .mode-ip mark:not(.type-ip) { background: var(--hl-dim); }
        .mode-domain mark.type-domain { background: var(--hl-active); }
        .mode-domain mark:not(.type-domain) { background: var(--hl-dim); }
        .mode-hash mark.type-hash { background: var(--hl-active); }
        .mode-hash mark:not(.type-hash) { background: var(--hl-dim); }

        /* Right Panel */
        .panel-workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-body); }
        .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 0 5px; overflow-x: auto; flex-shrink: 0; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 12px 15px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; white-space: nowrap; display: flex; align-items: center; gap: 8px; transition: color 0.2s; user-select: none; }
        .tab:hover { color: var(--accent); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .badge { background: var(--border); color: var(--text-main); font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; min-width: 16px; text-align: center; font-weight: 700; }
        .tab.active .badge { background: var(--accent); color: white; }

        /* Sources */
        .sources-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .sources-header { padding: 10px 15px; background: var(--bg-body); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; gap: 10px; }
        .sh-left { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; white-space: nowrap; }
        .sh-right { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding: 2px 2px 5px 2px; }
        
        .sources-container { flex: 1; overflow-y: auto; padding: 20px; }
        .sources-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 10px; }
        
        /* Overview Dashboard */
        .overview-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; padding-bottom: 20px; align-items: start; }
        .ov-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; max-height: 70vh; overflow: hidden; }
        .ov-header { padding: 8px 12px; border-bottom: 1px solid var(--border); font-weight: 600; background: rgba(0,0,0,0.02); display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-main); cursor: pointer; align-items: center; }
        .ov-header:hover { background: var(--bg-body); color: var(--accent); }
        .ov-content { padding: 0; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.8rem; color: var(--text-muted); flex: 1; }
        .ov-sub-title { padding: 4px 12px; font-size: 0.75rem; font-weight: 700; color: var(--text-main); background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); margin-top: -1px; }
        .ov-row { padding: 3px 12px; border-bottom: 1px dashed var(--border); display: flex; align-items: center; justify-content: space-between; overflow: hidden; }
        .ov-val { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .ov-remove-btn { opacity: 0; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: 700; padding: 0 0 0 8px; font-size: 0.9rem; }
        .ov-row:hover .ov-remove-btn { opacity: 1; }

        /* Source Card */
        .source-card { 
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius); height: 45px;
            padding: 0 8px; cursor: pointer; transition: all 0.1s; user-select: none; position: relative; 
            display: flex; align-items: center; justify-content: flex-start; text-align: left;
        }
        .source-card:hover { border-color: var(--accent); transform: translateY(-1px); }
        .source-card.selected { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); box-shadow: 0 0 0 1px var(--accent) inset; }
        .source-name { font-size: 0.85rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 10px 0 5px; flex: 1; }
        .ind-lookup { position: absolute; top: 4px; right: 5px; font-size: 0.65rem; opacity: 0.8; color: var(--accent); }
        .ind-custom { position: absolute; bottom: 3px; right: 5px; font-size: 0.65rem; opacity: 1; }

        /* Toolbar */
        .toolbar { padding: 8px 15px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 55px; gap: 10px; }
        .toolbar-stats { display: flex; gap: 15px; font-size: 0.8rem; color: var(--text-muted); }
        .stat-item span { color: var(--text-main); font-weight: 600; }
        .toolbar-actions { display: flex; gap: 8px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-panel); width: 90%; max-width: 650px; height: 526px; max-height: 90vh; border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.4); overflow: hidden; border: 1px solid var(--border); }
        .modal-header { padding: 12px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); color: var(--text-main); }
        .modal-header h2 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .modal-body { padding: 0; overflow-y: auto; flex: 1; display: flex; flex-direction: column; }
        
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 20px; background: var(--bg-body); overflow-x: auto; flex-shrink: 0; }
        .modal-tab { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; border-bottom: 2px solid transparent; color: var(--text-muted); white-space: nowrap; }
        .modal-tab.active { border-bottom-color: var(--accent); color: var(--accent); font-weight: 600; }
        .modal-tab-content { padding: 20px; display: none; overflow-y: auto; }
        .modal-tab-content.active { display: block; }
        
        .close-modal { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }

        /* Investigation Grid */
        .investigation-grid { display: grid; grid-template-columns: 2.5fr 1fr; height: 100%; overflow: hidden; }
        .inv-column { display: flex; flex-direction: column; overflow: hidden; height: 100%; border-right: 1px solid var(--border); }
        .inv-column:last-child { border-right: none; background: var(--bg-body); }
        .inv-column-header { padding: 8px 12px; background: var(--bg-body); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .inv-list { overflow-y: auto; flex: 1; padding: 0; }
        .inv-item { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; background: var(--bg-panel); border-left: 3px solid transparent; transition: opacity 0.2s; }
        .inv-item.disabled { opacity: 0.5; background: var(--bg-body); }
        .inv-item:hover { background: var(--bg-body); }
        .inv-item-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .inv-val { font-family: 'Consolas', monospace; font-weight: 600; color: var(--accent); font-size: 0.9rem; word-break: break-all; min-width: 0; }
        .inv-controls { display: flex; gap: 6px; align-items: center; }
        .verdict-select { padding: 4px; border-radius: 4px; border: 1px solid var(--border); font-size: 0.8rem; background: var(--bg-panel); color: var(--text-main); width: 110px; }
        .note-input { flex: 1; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; background: var(--bg-body); color: var(--text-main); min-width: 0; }
        .note-input:focus { border-color: var(--accent); outline: none; background: var(--bg-panel); }

        /* Settings Custom Sources */
        .custom-source-list { border: 1px solid var(--border); max-height: 250px; overflow-y: auto; margin-top: 10px; border-radius: 4px; display: none; }
        .custom-source-item { padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); }

        .toast { position: fixed; bottom: var(--toast-y); right: 25px; background: #333; color: white; padding: 12px 20px; border-radius: 6px; z-index: 2000; opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: #000; }

        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; vertical-align: middle; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .2s; border-radius: 20px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--accent); }
        input:checked + .toggle-slider:before { transform: translateX(16px); }

        .hidden { display: none !important; }
        .text-danger { color: var(--danger); }
        .text-muted { color: var(--text-muted); }
        .flex-gap { display: flex; gap: 10px; align-items: center; }
        
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 0.8rem; font-weight: 600; }
        .form-input, .form-select { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-panel); color: var(--text-main); box-sizing: border-box; font-size: 0.9rem; }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg-body); }

        /* Compact Grid: 0.8fr ID, 2.5fr Name, 1fr Type */
        .add-source-grid { display: grid; grid-template-columns: 0.8fr 2.5fr 1fr; gap: 10px; }
        .add-source-full { grid-column: 1 / -1; margin-top: -5px; } /* Pull up full width inputs */
        .settings-subheader { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin: 15px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }

        #custom-source-header { display: none; margin-top: 20px; font-size:0.9rem; }
        #no-sources-msg { margin-top: 20px; text-align: center; color: var(--text-muted); font-size: 0.85rem; font-style: italic; }

        @media (max-width: 900px) {
            main { flex-direction: column; }
            .panel-input { width: 100%; height: 35%; border-right: none; border-bottom: 1px solid var(--border); }
            .investigation-grid { grid-template-columns: 1fr; }
            .inv-column { border-right: none; border-bottom: 1px solid var(--border); }
            .inv-column:last-child { height: auto; max-height: 250px; flex: none; }
            .toolbar { height: auto; flex-wrap: nowrap; padding: 10px; gap: 10px; }
            .toolbar-stats { width: auto; gap: 10px; flex-shrink: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: 0.75rem; }
            .toolbar-actions { width: auto; flex-shrink: 0; }
            .btn-fancy { min-width: 0; }
            .add-source-grid { grid-template-columns: 1fr; }
            .add-source-full { margin-top: 0; }
        }
    </style>
</head>
<body>

<header>
    <div class="branding" id="branding-btn" title="New Investigation (Clear Notes)">
        <span style="font-size: 1.8rem;">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
        <div>
            <div class="logo-text">TotalOSINT</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">All-in-One Investigation Tool</div>
        </div>
    </div>
    <div class="nav-links">
        <a href="https://github.com/jhatzimalis/TotalOSINT" target="_blank" class="nav-link" title="GitHub Repo">
            <svg height="18" viewBox="0 0 16 16" width="18" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            GitHub
        </a>
        <button class="icon-btn" id="settings-btn" title="Settings">‚öôÔ∏è</button>
    </div>
</header>

<main>
    <!-- Left Panel: Input -->
    <div class="panel-input">
        <div class="panel-header">
            <span>Investigation Notes</span>
            <div class="header-actions">
                <button class="btn-fancy btn-sm btn-square" id="copy-input-btn" title="Copy Notes">
                    <div class="btn-fancy-icon" style="width:100%; border:none;">üìã</div>
                </button>
                <button class="btn-fancy btn-sm btn-square" id="clear-input-btn" title="Clear Notes">
                    <div class="btn-fancy-icon" style="width:100%; border:none;">üóëÔ∏è</div>
                </button>
            </div>
        </div>
        <div class="input-container">
            <div class="input-backdrop mode-overview" id="input-backdrop"></div>
            <textarea class="input-textarea" id="raw-input" placeholder="Paste notes or logs here...&#10;TotalOSINT will extract IPs, Domains, and Hashes automatically."></textarea>
        </div>
    </div>

    <!-- Right Panel: Workspace -->
    <div class="panel-workspace">
        <div class="tabs">
            <div class="tab active" data-type="overview">‚ö° Overview</div>
            <div class="tab" data-type="ip">IP Address <span class="badge" id="count-ip">0</span></div>
            <div class="tab" data-type="domain">Domain / URL <span class="badge" id="count-domain">0</span></div>
            <div class="tab" data-type="hash">File Hash <span class="badge" id="count-hash">0</span></div>
            <div class="tab" data-type="bookmarks">Bookmarks</div>
        </div>

        <div class="sources-wrapper">
            <!-- Source Toolbar -->
            <div class="sources-header hidden" id="sources-header">
                <div class="sh-left">Select Sources</div>
                <div class="sh-right">
                    <button class="btn-fancy btn-sm" id="select-all-btn">
                        <div class="btn-fancy-icon">‚òëÔ∏è</div>
                        <div class="btn-fancy-text">All</div>
                    </button>
                    <button class="btn-fancy btn-sm" id="deselect-all-btn">
                        <div class="btn-fancy-icon">‚¨ú</div>
                        <div class="btn-fancy-text">None</div>
                    </button>
                    <button class="btn-fancy btn-sm" id="sort-sources-btn">
                        <div class="btn-fancy-icon">üî§</div>
                        <div class="btn-fancy-text">Sort</div>
                    </button>
                    <button class="btn-fancy btn-sm" id="add-source-header-btn">
                        <div class="btn-fancy-icon">‚ûï</div>
                        <div class="btn-fancy-text">Add</div>
                    </button>
                </div>
            </div>

            <div class="sources-container">
                <div id="overview-dashboard" class="overview-dashboard"></div>
                <div id="sources-grid" class="sources-grid hidden"></div>
                <div id="no-data-msg" class="hidden" style="text-align: center; padding: 60px; color: var(--text-muted);"></div>
            </div>
        </div>

        <div class="toolbar">
            <div class="toolbar-stats" id="toolbar-stats">
                <div class="stat-item" id="stat-item-entities">Entities: <span id="stat-entities">0</span></div>
                <div style="opacity:0.3" id="stat-separator">|</div>
                <div class="stat-item" id="stat-item-sources">Sources: <span id="stat-sources">0</span></div>
            </div>
            <div class="toolbar-actions hidden" id="toolbar-actions">
                <button class="btn-fancy btn-square" id="launch-modal-open-btn" style="flex: 0 0 36px;" title="Open All Sources">
                    <div class="btn-fancy-icon" style="border:none; width:100%;">üåê</div>
                </button>
                <button class="btn-fancy btn-primary" id="launch-modal-btn" style="flex: 0 0 auto; min-width: 140px;">
                    <div class="btn-fancy-icon">üöÄ</div>
                    <div class="btn-fancy-text" id="launch-btn-text">Investigate</div>
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Investigation Modal -->
<div class="modal-overlay" id="investigation-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>üîé Investigation Workbench</h2>
            <button class="icon-btn close-modal" style="color:var(--text-main);">√ó</button>
        </div>
        <div class="modal-body">
            <div class="investigation-grid">
                <div class="inv-column">
                    <div class="inv-column-header">
                        <span>Extracted Entities (<span id="inv-entity-count">0</span>)</span>
                        <div class="flex-gap" style="font-size:0.8rem; text-transform:none; font-weight:normal;">
                             <label for="modal-defang">Defang</label>
                             <label class="toggle-switch"> 
                                <input type="checkbox" id="modal-defang"> 
                                <span class="toggle-slider"></span> 
                             </label>
                        </div>
                    </div>
                    <div class="inv-list" id="inv-entity-list"></div>
                </div>
                <div class="inv-column" style="background:var(--bg-body);">
                    <div class="inv-column-header">
                        <span id="inv-source-count-display">Target Sources (0)</span>
                    </div>
                    <div class="inv-list" id="inv-source-list" style="padding: 10px; max-height: 200px;"></div>
                    <div style="padding: 15px; display:flex; flex-direction:column; gap:10px; border-top:1px solid var(--border); background:var(--bg-panel); flex:none;">
                        <button class="btn-fancy btn-primary" id="execute-btn">
                            <div class="btn-fancy-icon">üåê</div>
                            <div class="btn-fancy-text">Open All Sources</div>
                        </button>
                        <hr style="width:100%; border:0; border-top:1px solid var(--border); margin:5px 0;">
                        <button class="btn-fancy" id="generate-report-btn">
                            <div class="btn-fancy-icon">üìã</div>
                            <div class="btn-fancy-text">Copy Report</div>
                        </button>
                        <div style="font-size:0.75rem; color:var(--text-muted); text-align:center;">Includes Verdicts & Notes</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal-overlay" id="preview-modal" style="z-index: 1100;">
    <div class="modal" style="max-width: 500px; max-height: 60vh;">
        <div class="modal-header">
            <h2 id="preview-title" style="font-size: 0.95rem; word-break: break-all;">Sources</h2>
            <button class="icon-btn close-modal" onclick="document.getElementById('preview-modal').classList.remove('open')" style="color:var(--text-main);">√ó</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div id="preview-list" style="padding: 10px;"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal" style="max-width: 650px; height: 526px; max-height: 90vh;">
        <div class="modal-header">
            <h2>‚öôÔ∏è Settings</h2>
            <button class="icon-btn close-modal" style="color:var(--text-main);">√ó</button>
        </div>
        <div class="modal-tabs">
            <div class="modal-tab active" data-tab="appearance">Appearance</div>
            <div class="modal-tab" data-tab="security">Security & Output</div>
            <div class="modal-tab" data-tab="sources">Custom Sources</div>
        </div>

        <div class="modal-body">
            <!-- Appearance Tab -->
            <div id="tab-appearance" class="modal-tab-content active">
                <div class="settings-subheader">Application Theme</div>
                <div class="form-group">
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <div style="flex:1; border:2px solid var(--border); padding:15px; border-radius:8px; cursor:pointer; text-align:center; opacity:0.7;" id="theme-card-light" onclick="setTheme('light')">
                            <span style="font-size:2rem; display:block;">‚òÄÔ∏è</span>Light Mode
                        </div>
                        <div style="flex:1; border:2px solid var(--border); padding:15px; border-radius:8px; cursor:pointer; text-align:center; opacity:0.7;" id="theme-card-dark" onclick="setTheme('dark')">
                            <span style="font-size:2rem; display:block;">üåô</span>Dark Mode
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
             <div id="tab-security" class="modal-tab-content">
                <div class="settings-subheader">Security</div>
                <div class="form-group">
                    <label>Global De-fang</label>
                    <div class="flex-gap">
                        <label class="toggle-switch"> <input type="checkbox" id="setting-defang"> <span class="toggle-slider"></span> </label>
                        <span style="font-size:0.85rem; color:var(--text-muted);">Replace <code>.</code> with <code>[.]</code></span>
                    </div>
                </div>
                
                <div class="settings-subheader" style="margin-top:30px;">Output</div>
                <div class="form-group">
                    <label>Reference URLs in Report</label>
                    <div class="flex-gap">
                        <label class="toggle-switch"> <input type="checkbox" id="setting-reference"> <span class="toggle-slider"></span> </label>
                        <span style="font-size:0.85rem; color:var(--text-muted);">Include list of lookup URLs</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Report Separator</label>
                    <select class="form-select" id="setting-separator">
                        <option value="newline">Double Newline (Standard)</option>
                        <option value="single">Single Newline (Compact)</option>
                        <option value="dash">Dashes (---)</option>
                        <option value="comma">Comma Separated</option>
                    </select>
                </div>
            </div>

            <!-- Custom Sources Tab -->
            <div id="tab-sources" class="modal-tab-content">
                <div style="background: var(--bg-body); padding: 10px; border-radius: 6px; border: 1px solid var(--border);">
                    <div class="add-source-grid">
                        <div class="form-group">
                            <label>ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-input" id="cs-id" placeholder="MY_TOOL" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-input" id="cs-name" placeholder="My Tool">
                        </div>
                        <div class="form-group">
                            <label>Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="cs-type">
                                <option value="ip">IP</option>
                                <option value="domain">Domain</option>
                                <option value="hash">Hash</option>
                                <option value="bookmarks">Bookmark</option>
                            </select>
                        </div>
                        <div class="form-group add-source-full">
                            <label>Home URL <span class="text-danger">*</span></label>
                            <input type="text" class="form-input" id="cs-home" placeholder="https://tool.com">
                        </div>
                        <div class="form-group add-source-full">
                            <label>Lookup URL (Optional)</label>
                            <input type="text" class="form-input" id="cs-lookup" placeholder="https://tool.com/search?q=">
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button class="btn-fancy" id="add-custom-source-btn" style="height:32px;">
                            <div class="btn-fancy-icon">‚ûï</div>
                            <div class="btn-fancy-text" id="add-source-text">Add Source</div>
                        </button>
                        <button class="btn-fancy hidden" id="cancel-edit-btn" style="height:32px; width:100px; flex:none;">
                            <div class="btn-fancy-text">Cancel</div>
                        </button>
                    </div>
                </div>
                <h4 id="custom-source-header">Your Custom Sources</h4>
                <div id="no-sources-msg">No custom sources added.</div>
                <div class="custom-source-list" id="custom-source-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- Data -->
<script src="sources.js"></script>
<script>
    if (typeof sources === 'undefined') {
        window.sources = {
            ip: [ { id: 'AIPDB', name: 'AbuseIPDB', url: 'https://www.abuseipdb.com/', lookupurl: 'https://www.abuseipdb.com/check/' }, { id: 'IPQS', name: 'IPQualityScore', url: 'https://www.ipqualityscore.com/', lookupurl: 'https://www.ipqualityscore.com/vpn-ip-address-check/lookup/' }, { id: 'VT', name: 'VirusTotal', url: 'https://www.virustotal.com/', lookupurl: 'https://www.virustotal.com/gui/ip-address/' }, { id: 'GGL', name: 'Google Search', url: 'https://google.com', lookupurl: 'https://google.com/search?q=' } ],
            domain: [ { id: 'URLSCAN', name: 'urlscan.io', url: 'https://urlscan.io/', lookupurl: 'https://urlscan.io/search/#' }, { id: 'BRWLR', name: 'Browserling', url: 'https://www.browserling.com/', lookupurl: 'https://www.browserling.com/browse/win10/chrome127/' }, { id: 'VT', name: 'VirusTotal', url: 'https://www.virustotal.com/', lookupurl: 'https://www.virustotal.com/gui/domain/' }, { id: 'GGL', name: 'Google Search', url: 'https://google.com', lookupurl: 'https://google.com/search?q=' } ],
            hash: [ { id: 'VT', name: 'VirusTotal', url: 'https://www.virustotal.com/', lookupurl: 'https://www.virustotal.com/gui/file/' }, { id: 'ARUN', name: 'Any.Run', url: 'https://app.any.run/', lookupurl: 'https://app.any.run/submissions/sample/' }, { id: 'HYBAN', name: 'Hybrid Analysis', url: 'https://www.hybrid-analysis.com', lookupurl: 'https://www.hybrid-analysis.com/sample/' } ],
            bookmarks: [ { id: 'GGADV', name: 'Google Adv Search', url: 'https://www.google.com/advanced_search' }, { id: 'HIBP', name: 'Have I Been Pwned', url: 'https://haveibeenpwned.com/' }, { id: 'OSFMW', name: 'OSINT Framework', url: 'https://osintframework.com/' }, { id: 'GOOS', name: 'Goosint', url: 'https://goosint.com/' }, { id: 'CYCHF', name: 'CyberChef', url: 'https://gchq.github.io/CyberChef/' } ]
        };
    }
</script>

<script>
    /* --- APP STATE --- */
    const app = {
        data: { ip: [], domain: [], hash: [] },
        selectedSources: { ip: [], domain: [], hash: [], bookmarks: [] },
        currentTab: 'overview',
        customSources: [],
        verdicts: {},
        disabledEntities: {}, 
        sortDesc: false, 
        settings: { theme: 'dark', defang: true, separator: 'newline', showReference: true },
        debounceTimer: null,
        editingId: null
    };

    /* --- DOM ELEMENTS --- */
    const els = {
        input: document.getElementById('raw-input'),
        backdrop: document.getElementById('input-backdrop'),
        grid: document.getElementById('sources-grid'),
        sourcesHeader: document.getElementById('sources-header'),
        dashboard: document.getElementById('overview-dashboard'),
        msg: document.getElementById('no-data-msg'),
        tabs: document.querySelectorAll('.tab'),
        counts: { ip: document.getElementById('count-ip'), domain: document.getElementById('count-domain'), hash: document.getElementById('count-hash') },
        stats: { ent: document.getElementById('stat-entities'), src: document.getElementById('stat-sources'), itemEnt: document.getElementById('stat-item-entities'), itemSrc: document.getElementById('stat-item-sources'), sep: document.getElementById('stat-separator') },
        toolbarActions: document.getElementById('toolbar-actions'),
        launchBtns: { modal: document.getElementById('launch-modal-btn'), direct: document.getElementById('launch-modal-open-btn'), text: document.getElementById('launch-btn-text') },
        modals: { inv: document.getElementById('investigation-modal'), settings: document.getElementById('settings-modal'), preview: document.getElementById('preview-modal') }
    };

    /* --- INITIALIZATION --- */
    function init() {
        if (typeof sources !== 'undefined') window.sources = sources;
        loadSettings();
        mergeSources();
        setupEvents();
        els.input.value = ''; // Clean start
        els.input.focus();
        renderOverview(); 
        switchTab('overview');
    }

    function loadSettings() {
        const s = localStorage.getItem('totalosint_settings');
        if(s) app.settings = {...app.settings, ...JSON.parse(s)};
        setTheme(app.settings.theme);
        document.getElementById('setting-defang').checked = app.settings.defang;
        document.getElementById('modal-defang').checked = app.settings.defang;
        document.getElementById('setting-reference').checked = app.settings.showReference;
        document.getElementById('setting-separator').value = app.settings.separator;
        const cs = localStorage.getItem('totalosint_custom_sources');
        if(cs) app.customSources = JSON.parse(cs);
    }
    function saveSettings() { localStorage.setItem('totalosint_settings', JSON.stringify(app.settings)); }
    
    function setTheme(theme) {
        app.settings.theme = theme;
        if(theme === 'light') document.body.classList.add('theme-light');
        else document.body.classList.remove('theme-light');
        document.getElementById('theme-card-light').style.opacity = theme === 'light' ? '1' : '0.6';
        document.getElementById('theme-card-light').style.borderColor = theme === 'light' ? 'var(--accent)' : 'var(--border)';
        document.getElementById('theme-card-dark').style.opacity = theme === 'dark' ? '1' : '0.6';
        document.getElementById('theme-card-dark').style.borderColor = theme === 'dark' ? 'var(--accent)' : 'var(--border)';
        saveSettings();
    }

    function mergeSources() {
        app.customSources.forEach(cs => {
            if(window.sources[cs.type] && !window.sources[cs.type].find(x => x.id === cs.id)) window.sources[cs.type].push(cs);
        });
    }

    function clearNotes() {
        els.input.value = '';
        els.input.focus();
        analyzeInput();
    }
    
    function softReset() {
        clearNotes();
        // Keep selected sources, clear data only
        app.data = { ip: [], domain: [], hash: [] };
        app.verdicts = {};
        app.disabledEntities = {};
        renderOverview();
        switchTab('overview');
    }

    /* --- ANALYSIS --- */
    const R = {
        url: /https?:\/\/[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}(?:\/[^\s<>"']*)?/g,
        ipv6: /((?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,7}:(?:[0-9a-fA-F]{1,4}(?::[0-9a-fA-F]{1,4})*)?|::(?:[0-9a-fA-F]{1,4}(?::[0-9a-fA-F]{1,4})*)?)/g,
        ipv4: /\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/g,
        hash: /\b[a-fA-F0-9]{32}\b|\b[a-fA-F0-9]{40}\b|\b[a-fA-F0-9]{64}\b/g,
        domain: /(?<![\w@\.\-\/])\b([a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z]{2,63}\b/gi,
    };

    function onInputChanged() {
        clearTimeout(app.debounceTimer);
        generateHighlights(); 
        app.debounceTimer = setTimeout(analyzeInput, 600);
    }

    function analyzeInput() {
        const text = els.input.value;
        app.data = { ip: [], domain: [], hash: [] };
        
        if(!text.trim()) {
            ['ip','domain','hash'].forEach(k => els.counts[k].innerText = 0);
            renderOverview();
            generateHighlights(); 
            return;
        }

        let rawURLs = text.match(R.url) || [];
        rawURLs = rawURLs.map(u => u.replace(/[.,;?!:)"'\]>]+$/, ""));

        const rawIPv6s = text.match(R.ipv6) || [];
        const rawIPv4s = text.match(R.ipv4) || [];
        const rawHashes = text.match(R.hash) || [];
        const rawDomains = text.match(R.domain) || [];

        const urlSet = new Set(rawURLs);
        urlSet.forEach(u => {
            app.data.domain.push({ val: u, type: 'URL' });
            try {
                const urlObj = new URL(u.startsWith('http') ? u : 'http://' + u); 
                if (urlObj.hostname && urlObj.hostname.includes('.')) app.data.domain.push({ val: urlObj.hostname, type: 'Domain' });
            } catch(e) {}
        });

        [...new Set(rawDomains)].forEach(d => {
            if(!d.match(/^\d+\.\d+\.\d+\.\d+$/)) app.data.domain.push({ val: d, type: 'Domain' });
        });

        [...new Set(rawIPv6s)].forEach(ip => app.data.ip.push({ val: ip, type: 'IPv6' }));
        [...new Set(rawIPv4s)].forEach(ip => app.data.ip.push({ val: ip, type: 'IPv4' }));
        
        [...new Set(rawHashes)].forEach(h => {
            let t = 'Hash';
            if(h.length === 32) t = 'MD5';
            else if(h.length === 40) t = 'SHA-1';
            else if(h.length === 64) t = 'SHA-256';
            app.data.hash.push({ val: h, type: t });
        });
        
        app.data.domain = removeDuplicates(app.data.domain);
        app.data.ip = removeDuplicates(app.data.ip);
        app.data.hash = removeDuplicates(app.data.hash);

        const sorter = (a, b) => a.val.localeCompare(b.val, undefined, { numeric: true });
        app.data.ip.sort(sorter);
        app.data.domain.sort(sorter);
        app.data.hash.sort(sorter);

        updateCounts();
        if(app.currentTab === 'overview') renderOverview();
        updateUI();
        generateHighlights(); 
    }

    function removeDuplicates(arr) {
        const unique = new Set();
        return arr.filter(item => {
            const key = item.val + '|' + item.type;
            if(unique.has(key)) return false;
            unique.add(key);
            return true;
        });
    }

    function updateCounts() {
        els.counts.ip.innerText = app.data.ip.length;
        els.counts.domain.innerText = app.data.domain.length;
        els.counts.hash.innerText = app.data.hash.length;
    }

    function renderOverview() {
        const dash = els.dashboard;
        dash.innerHTML = '';
        const totalItems = app.data.ip.length + app.data.domain.length + app.data.hash.length;

        if(totalItems === 0) {
            dash.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; color:var(--text-muted); padding:60px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 15px; opacity:0.8;">üëã</div>
                    <div style="font-size: 1.1rem; font-weight:500; margin-bottom:5px;">Ready to Analyze</div>
                    <div style="font-size: 0.9rem;">Paste text to extract IPs, Domains, and Hashes.</div>
                </div>
            `;
            return;
        }

        ['ip','domain','hash'].forEach(key => {
             const items = app.data[key];
             if(items.length === 0) return;
             
             const subgroups = {};
             items.forEach(i => {
                if(!subgroups[i.type]) subgroups[i.type] = [];
                subgroups[i.type].push(i.val);
             });

             const card = document.createElement('div');
             card.className = 'ov-card';
             card.innerHTML = `<div class="ov-header" onclick="switchTab('${key}')"><span>${key === 'ip' ? 'IP Address' : key === 'domain' ? 'Domain / URL' : 'File Hash'}</span> <span>${items.length} ‚ûî</span></div>`;
             
             const content = document.createElement('div');
             content.className = 'ov-content';
             
             Object.keys(subgroups).sort().forEach(subKey => {
                content.innerHTML += `<div class="ov-sub-title">${subKey}</div>`;
                subgroups[subKey].forEach(val => {
                    const row = document.createElement('div');
                    row.className = 'ov-row';
                    const safeVal = val.replace(/"/g, '&quot;');
                    row.innerHTML = `<span class="ov-val" title="${safeVal}">${safeVal}</span>`;
                    content.appendChild(row);
                });
             });
             card.appendChild(content);
             dash.appendChild(card);
        });
    }

    function generateHighlights() {
        let text = els.input.value;
        if(!text) { els.backdrop.innerHTML = ''; return; }
        text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const wrap = (t, rx, cls) => t.replace(rx, m => `<mark class="${cls}">${m}</mark>`);
        text = wrap(text, R.hash, 'type-hash');
        text = wrap(text, R.url, 'type-domain'); 
        text = wrap(text, R.domain, 'type-domain'); 
        text = wrap(text, R.ipv6, 'type-ip');
        text = wrap(text, R.ipv4, 'type-ip');
        els.backdrop.innerHTML = text.replace(/\n/g, '<br>') + '<br>';
    }

    function syncScroll() { els.backdrop.scrollTop = els.input.scrollTop; }

    /* --- UI & TABS --- */
    function switchTab(type) {
        app.currentTab = type;
        els.tabs.forEach(t => t.classList.toggle('active', t.dataset.type === type));
        
        const isOverview = type === 'overview';
        els.dashboard.classList.toggle('hidden', !isOverview);
        els.grid.classList.toggle('hidden', isOverview);
        els.sourcesHeader.classList.toggle('hidden', isOverview);
        els.backdrop.className = `input-backdrop mode-${type}`;

        if (type === 'overview') {
            els.toolbarActions.classList.add('hidden');
            renderOverview(); 
        } else if (type === 'bookmarks') {
            els.toolbarActions.classList.remove('hidden');
            els.launchBtns.modal.classList.add('hidden'); 
            els.launchBtns.direct.title = "Open All Sources"; 
            renderSources();
            els.msg.style.display = 'none';
        } else {
            els.toolbarActions.classList.remove('hidden');
            els.launchBtns.modal.classList.remove('hidden');
            els.launchBtns.direct.title = "Open All Sources"; 
            renderSources();
            const count = app.data[type]?.length || 0;
            els.msg.style.display = (count === 0) ? 'block' : 'none';
            els.msg.innerHTML = `<i>No entities detected for this category.</i>`;
        }

        updateUI();
    }

    function renderSources() {
        const list = window.sources[app.currentTab] || [];
        list.sort((a,b) => app.sortDesc ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name));

        els.grid.innerHTML = '';
        list.forEach(src => {
            const isSel = app.selectedSources[app.currentTab].includes(src.id);
            const isCustom = app.customSources.find(c => c.id === src.id);
            
            const el = document.createElement('div');
            el.className = `source-card ${isSel ? 'selected' : ''}`;
            el.title = src.name; 
            
            let html = `<span class="source-name">${src.name}</span>`;
            if(src.lookupurl) html += `<span class="ind-lookup">üîç</span>`;
            if(isCustom) html += `<span class="ind-custom">‚ú®</span>`;
            
            el.innerHTML = html;
            el.onclick = () => toggleSource(src.id);
            els.grid.appendChild(el);
        });
    }

    function toggleSource(id) {
        const arr = app.selectedSources[app.currentTab];
        const idx = arr.indexOf(id);
        if (idx > -1) arr.splice(idx, 1);
        else arr.push(id);
        renderSources();
        updateUI();
    }

    function updateUI() {
        const tab = app.currentTab;
        const srcCount = app.selectedSources[tab]?.length || 0;
        const entCount = (tab === 'bookmarks') ? 0 : app.data[tab]?.length || 0;
        const totalEnt = app.data.ip.length + app.data.domain.length + app.data.hash.length;

        els.stats.ent.innerText = tab === 'overview' ? totalEnt : entCount;
        els.stats.src.innerText = srcCount;
        
        const showStats = tab !== 'overview' && tab !== 'bookmarks';
        els.stats.itemEnt.classList.toggle('hidden', !showStats && tab !== 'overview');
        els.stats.itemSrc.classList.toggle('hidden', tab === 'overview');
        els.stats.sep.classList.toggle('hidden', tab === 'overview' || tab === 'bookmarks');
    }

    /* --- INVESTIGATION --- */
    function openInvestigation() {
        const tab = app.currentTab;
        if(tab === 'overview' || tab === 'bookmarks') return;

        const sourceIds = app.selectedSources[tab];
        if (sourceIds.length === 0) return toast("Select at least one source.", "error");
        
        let entities = app.data[tab];
        
        if(entities.length === 0) {
            document.getElementById('inv-entity-count').innerText = 0;
            document.getElementById('inv-entity-list').innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted);">No entities.</div>`;
        } else {
            document.getElementById('inv-entity-count').innerText = entities.length;
            const list = document.getElementById('inv-entity-list');
            list.innerHTML = '';

            entities.forEach(entObj => {
                const ent = entObj.val;
                if(!app.verdicts[ent]) app.verdicts[ent] = { status: 'Untriaged', note: '' };
                const v = app.verdicts[ent];
                const displayEnt = app.settings.defang ? ent.replace(/\./g, '[.]') : ent;
                const isDisabled = !!app.disabledEntities[ent];

                const div = document.createElement('div');
                div.className = `inv-item ${isDisabled ? 'disabled' : ''}`;
                div.dataset.val = ent;
                div.innerHTML = `
                    <div class="inv-item-header">
                        <span class="inv-val" title="${ent}">${displayEnt}</span>
                        <div class="flex-gap" style="gap:5px;">
                            <button class="icon-btn" title="Preview" style="font-size:0.9rem;" onclick="previewSources('${ent}')">üìú</button>
                            <button class="icon-btn" title="Copy" style="font-size:0.9rem;" onclick="copyToClip('${displayEnt}', true)">üìã</button>
                            <button class="icon-btn" title="${isDisabled ? 'Enable' : 'Disable'}" style="font-size:0.9rem; opacity:${isDisabled?1:0.6}" onclick="toggleEntityDisable('${ent}')">${isDisabled ? 'üëÅÔ∏è' : 'üö´'}</button>
                        </div>
                    </div>
                    <div class="inv-controls">
                        <select class="verdict-select" onchange="updateVerdict('${ent}', 'status', this.value)">
                            <option value="Untriaged" ${v.status === 'Untriaged'?'selected':''}>Untriaged</option>
                            <option value="Safe" ${v.status === 'Safe'?'selected':''}>‚úÖ Safe</option>
                            <option value="Suspicious" ${v.status === 'Suspicious'?'selected':''}>‚ö†Ô∏è Suspicious</option>
                            <option value="Malicious" ${v.status === 'Malicious'?'selected':''}>‚õî Malicious</option>
                        </select>
                        <input type="text" class="note-input" placeholder="Notes..." value="${v.note}" oninput="updateVerdict('${ent}', 'note', this.value)">
                    </div>
                `;
                list.appendChild(div);
            });
        }

        const srcList = document.getElementById('inv-source-list');
        srcList.innerHTML = '';
        const activeSrc = window.sources[tab].filter(s => sourceIds.includes(s.id));
        document.getElementById('inv-source-count-display').innerText = `Target Sources (${activeSrc.length})`;
        activeSrc.forEach(s => {
            srcList.innerHTML += `<div style="font-size:0.8rem; padding:3px 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">‚Ä¢ ${s.name}</div>`;
        });

        els.modals.inv.classList.add('open');
    }

    window.toggleEntityDisable = (ent) => {
        app.disabledEntities[ent] = !app.disabledEntities[ent];
        const item = document.querySelector(`.inv-item[data-val="${ent}"]`);
        if(item) {
            item.classList.toggle('disabled', app.disabledEntities[ent]);
            const btn = item.querySelector('button[title="Disable"], button[title="Enable"]');
            if(btn) {
                 btn.title = app.disabledEntities[ent] ? "Enable" : "Disable";
                 btn.innerHTML = app.disabledEntities[ent] ? "üëÅÔ∏è" : "üö´";
                 btn.style.opacity = app.disabledEntities[ent] ? "1" : "0.6";
            }
        }
    };

    window.previewSources = (ent) => {
        const tab = app.currentTab;
        const sourceIds = app.selectedSources[tab];
        const activeSrc = window.sources[tab].filter(s => sourceIds.includes(s.id));
        const list = document.getElementById('preview-list');
        list.innerHTML = '';
        document.getElementById('preview-title').innerText = ent;
        activeSrc.forEach(src => {
             let url = src.url;
             if(ent && src.lookupurl) url = src.lookupurl + encodeURIComponent(ent);
             list.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid var(--border);"><span style="font-size:0.85rem;">${src.name}</span><a href="${url}" target="_blank" class="btn-fancy btn-sm" style="flex:0 0 auto; width:auto; text-decoration:none; padding:0 8px; display:flex;">Open ‚Üó</a></div>`;
        });
        els.modals.preview.classList.add('open');
    };

    function executeInvestigation() {
        const tab = app.currentTab;
        const sourceIds = app.selectedSources[tab];
        
        if(tab === 'bookmarks') {
            const allSrcs = window.sources.bookmarks || [];
            const selected = allSrcs.filter(s => sourceIds.includes(s.id));
            if(selected.length === 0) return toast("No bookmarks selected.", "error");
            if(selected.length > 10 && !confirm(`Open ${selected.length} tabs?`)) return;
            selected.forEach(s => window.open(s.url, '_blank'));
            return;
        }

        // Logic for running without entities (Use Home URL)
        let entities = app.data[tab].filter(e => !app.disabledEntities[e.val]);
        if(entities.length === 0) entities = [{val: ''}]; // Dummy empty entity to trigger loop

        if(sourceIds.length === 0) return toast("Select sources first.", "error");

        let urls = [];
        entities.forEach(obj => {
            const ent = obj.val;
            window.sources[tab].filter(s => sourceIds.includes(s.id)).forEach(src => {
                let target = src.url; // Default to home URL
                // Only use lookup if entity exists and source has lookup
                if (ent && ent !== '' && src.lookupurl) {
                    target = src.lookupurl + encodeURIComponent(ent);
                }
                urls.push(target);
            });
        });

        urls = [...new Set(urls)];
        if(urls.length > 20 && !confirm(`Open ${urls.length} tabs?`)) return;
        urls.forEach(u => window.open(u, '_blank'));
    }

    function generateReport() {
        const entities = app.data[app.currentTab].filter(e => !app.disabledEntities[e.val]);
        if(entities.length === 0) return toast("No entities to report.", "warning");

        let report = "";
        const sepMap = { 'newline': '\n\n', 'single': '\n', 'dash': '\n---\n', 'comma': ', ' };
        const sep = sepMap[app.settings.separator] || '\n\n';
        const sourceIds = app.selectedSources[app.currentTab];
        const activeSources = window.sources[app.currentTab].filter(s => sourceIds.includes(s.id));

        entities.forEach((obj, i) => {
            const ent = obj.val;
            const v = app.verdicts[ent] || { status: 'Untriaged', note: '' };
            const displayEnt = app.settings.defang ? ent.replace(/\./g, '[.]').replace(/http/gi, 'hxxp') : ent;
            
            report += `${obj.type}: ${displayEnt}\n`;
            report += `Verdict: ${v.status}\n`;
            if(v.note) report += `Note: ${v.note}\n`;
            if(app.settings.showReference && activeSources.length > 0) {
                report += `References:\n`;
                activeSources.forEach(src => {
                     let url = src.url;
                     if(ent && src.lookupurl) url = src.lookupurl + encodeURIComponent(ent);
                     report += `${url}\n`;
                });
            }
            if(i < entities.length - 1) report += sep;
        });
        copyToClip(report);
    }

    /* --- HELPERS --- */
    window.updateVerdict = (ent, key, val) => {
        if(!app.verdicts[ent]) app.verdicts[ent] = { status: 'Untriaged', note: '' };
        app.verdicts[ent][key] = val;
    };
    window.copyToClip = (text, msg = 'Report copied!') => {
        navigator.clipboard.writeText(text).then(() => toast(msg, "success"));
    };
    function toast(msg, type='info') {
        const t = document.getElementById('toast');
        t.innerHTML = `<span>${type === 'error' ? '‚ö†Ô∏è' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}</span> ${msg}`;
        t.className = `toast visible ${type}`;
        setTimeout(() => t.classList.remove('visible'), 3000);
    }

    /* --- EVENTS --- */
    function setupEvents() {
        els.input.addEventListener('input', onInputChanged);
        els.input.addEventListener('scroll', syncScroll);
        
        document.getElementById('branding-btn').onclick = softReset;
        document.getElementById('clear-input-btn').onclick = clearNotes;
        document.getElementById('copy-input-btn').onclick = () => copyToClip(els.input.value, 'Notes copied!');

        document.getElementById('select-all-btn').onclick = () => { app.selectedSources[app.currentTab] = window.sources[app.currentTab].map(s => s.id); renderSources(); updateUI(); };
        document.getElementById('deselect-all-btn').onclick = () => { app.selectedSources[app.currentTab] = []; renderSources(); updateUI(); };
        document.getElementById('sort-sources-btn').onclick = () => { app.sortDesc = !app.sortDesc; renderSources(); };
        document.getElementById('add-source-header-btn').onclick = () => { document.querySelector('.modal-tab[data-tab="sources"]').click(); els.modals.settings.classList.add('open'); };

        els.tabs.forEach(t => t.onclick = () => switchTab(t.dataset.type));
        document.querySelectorAll('.close-modal').forEach(b => b.onclick = () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')));
        document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', (e) => { if(e.target === m) m.classList.remove('open'); }));
        
        document.getElementById('settings-btn').onclick = () => els.modals.settings.classList.add('open');
        document.getElementById('add-custom-source-btn').onclick = addCustomSource;
        document.getElementById('cancel-edit-btn').onclick = cancelEdit;
        
        els.launchBtns.modal.onclick = openInvestigation;
        els.launchBtns.direct.onclick = executeInvestigation;
        document.getElementById('execute-btn').onclick = executeInvestigation;
        document.getElementById('generate-report-btn').onclick = generateReport;

        document.querySelectorAll('.modal-tab').forEach(t => t.onclick = function() {
            document.querySelectorAll('.modal-tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(`tab-${this.dataset.tab}`).classList.add('active');
            if(this.dataset.tab === 'sources') renderCustomSourcesList();
        });

        document.getElementById('setting-defang').onchange = (e) => { app.settings.defang = e.target.checked; saveSettings(); };
        document.getElementById('setting-separator').onchange = (e) => { app.settings.separator = e.target.value; saveSettings(); };
        document.getElementById('setting-reference').onchange = (e) => { app.settings.showReference = e.target.checked; saveSettings(); };
        document.getElementById('modal-defang').onchange = (e) => { app.settings.defang = e.target.checked; document.getElementById('setting-defang').checked = e.target.checked; saveSettings(); if(els.modals.inv.classList.contains('open')) openInvestigation(); };
        document.getElementById('cs-id').oninput = function() { this.value = this.value.toUpperCase().replace(/[^A-Z_]/g, ''); };
        
        // Disable lookup for bookmarks
        const typeSelect = document.getElementById('cs-type');
        const lookupInput = document.getElementById('cs-lookup');
        typeSelect.onchange = () => {
            if(typeSelect.value === 'bookmarks') {
                lookupInput.disabled = true; lookupInput.value = ''; lookupInput.placeholder = 'N/A';
            } else {
                lookupInput.disabled = false; lookupInput.placeholder = 'https://tool.com/search?q=';
            }
        };
    }

    window.editCustomSource = (id) => {
        const src = app.customSources.find(s => s.id === id);
        if(!src) return;
        
        // Populate
        document.getElementById('cs-id').value = src.id;
        document.getElementById('cs-name').value = src.name;
        document.getElementById('cs-type').value = src.type;
        document.getElementById('cs-home').value = src.url;
        document.getElementById('cs-lookup').value = src.lookupurl;
        document.getElementById('cs-type').onchange();
        
        // UI State
        document.getElementById('cs-id').disabled = true; // Cannot change ID
        document.getElementById('add-source-text').innerText = "Save Changes";
        document.getElementById('add-custom-source-btn').classList.remove('btn-fancy');
        document.getElementById('add-custom-source-btn').classList.add('btn-success', 'btn-fancy');
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        
        app.editingId = id;
    };

    function cancelEdit() {
        resetSourceForm();
        app.editingId = null;
    }

    function addCustomSource() {
        const id = document.getElementById('cs-id').value;
        const name = document.getElementById('cs-name').value;
        const type = document.getElementById('cs-type').value;
        const home = document.getElementById('cs-home').value;
        const lookup = document.getElementById('cs-lookup').value;

        if(!id || !name || !home) return toast("ID, Name, and Home URL required", "error");
        
        // Check duplicate only if NEW
        if(!app.editingId && app.customSources.find(c => c.id === id)) return toast("ID already exists", "error");
        
        // Remove old if editing
        if(app.editingId) {
            app.customSources = app.customSources.filter(s => s.id !== app.editingId);
        }

        const newSrc = { id, name, type, url: home, lookupurl: lookup || '' };
        app.customSources.push(newSrc);
        localStorage.setItem('totalosint_custom_sources', JSON.stringify(app.customSources));
        
        // Refresh runtime sources
        if(window.sources[type]) {
            // Remove old if exists in runtime (for editing)
            window.sources[type] = window.sources[type].filter(s => s.id !== id);
            window.sources[type].push(newSrc);
        }

        toast(app.editingId ? "Source updated!" : "Source added!", "success");
        renderCustomSourcesList();
        resetSourceForm();
        if(app.currentTab === type) renderSources(); // Refresh UI
    }

    function resetSourceForm() {
        document.getElementById('cs-id').value = '';
        document.getElementById('cs-name').value = '';
        document.getElementById('cs-home').value = '';
        document.getElementById('cs-lookup').value = '';
        document.getElementById('cs-id').disabled = false;
        document.getElementById('add-source-text').innerText = "Add Source";
        document.getElementById('add-custom-source-btn').classList.remove('btn-success');
        document.getElementById('cancel-edit-btn').classList.add('hidden');
        app.editingId = null;
    }

    function removeCustomSource(id) {
        if(app.editingId === id) cancelEdit();
        app.customSources = app.customSources.filter(s => s.id !== id);
        localStorage.setItem('totalosint_custom_sources', JSON.stringify(app.customSources));
        renderCustomSourcesList();
        // Remove from runtime
        Object.keys(window.sources).forEach(key => {
            window.sources[key] = window.sources[key].filter(s => s.id !== id);
        });
        renderSources();
        toast("Source removed", "warning");
    }

    function renderCustomSourcesList() {
        const container = document.getElementById('custom-source-list');
        const header = document.getElementById('custom-source-header');
        const msg = document.getElementById('no-sources-msg');
        
        if(app.customSources.length === 0) { 
            container.style.display = 'none'; 
            header.style.display = 'none';
            msg.style.display = 'block';
            return; 
        }
        
        container.style.display = 'block';
        header.style.display = 'block';
        msg.style.display = 'none';
        container.innerHTML = '';
        
        app.customSources.forEach(s => {
            const div = document.createElement('div');
            div.className = 'custom-source-item';
            div.innerHTML = `
                <div><div style="font-weight:600; font-size:0.9rem;">${s.name}</div><div style="font-size:0.75rem; color:var(--text-muted);">${s.id} (${s.type})</div></div>
                <div style="display:flex; gap:5px;">
                    <button class="icon-btn" onclick="editCustomSource('${s.id}')" style="font-size:1rem;">‚úèÔ∏è</button>
                    <button class="icon-btn" onclick="removeCustomSource('${s.id}')" style="color:var(--danger); font-size:1rem;">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
