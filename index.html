<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TotalOSINT</title>
    
    <!-- Metadata -->
    <meta name="description" content="TotalOSINT is a privacy-first, client-side OSINT toolkit for security analysts. Instantly extract IOCs (IPs, Domains, Hashes) from raw logs and launch bulk investigations across dozens of threat intelligence sources. Zero-data-persistence workflow for SOC and DFIR teams. No installation required.">
    <meta name="keywords" content="osint, threat-intelligence, cybersecurity, soc, blue-team, incident-response, investigation, ioc-extraction, dfir, opsec, malware-analysis, security-tools, productivity, javascript, infosec, digital-forensics, threat-hunting, ioc-parser, ip-lookup, hash-lookup, reconnaissance, privacy-focused, client-side, zero-persistence, secops">
    
    <!-- Open Graph / Social Sharing -->
    <meta property="og:title" content="TotalOSINT">
    <meta property="og:description" content="TotalOSINT is a privacy-first, client-side OSINT toolkit. Extract IOCs and launch investigations instantly.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jhatzimalis.github.io/TotalOSINT/">
    <meta property="og:image" content="https://jhatzimalis.github.io/TotalOSINT/social.png">
    <meta property="og:image:width" content="1280">
    <meta property="og:image:height" content="640">
    
    <!-- Twitter Card Data -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TotalOSINT">
    <meta name="twitter:description" content="Privacy-first, client-side OSINT toolkit for security analysts.">
    <meta name="twitter:image" content="https://jhatzimalis.github.io/TotalOSINT/social.png">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïµÔ∏è‚Äç‚ôÇÔ∏è</text></svg>">

    <style>
        /* --- Variables --- */
        :root {
            --bg-body: #0f172a; --bg-panel: #1e293b; --bg-header: #020617;
            --text-main: #f1f5f9; --text-muted: #94a3b8; --text-light: #ecf0f1;
            --accent: #3b82f6; --accent-hover: #60a5fa; 
            --border: #334155; --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --radius: 6px;
            --hl-dim: rgba(255, 255, 255, 0.08); 
            --hl-active: rgba(59, 130, 246, 0.5); 
            --toast-y: 85px; 
        }

        body.theme-light {
            --bg-body: #f4f6f8; --bg-panel: #ffffff; --bg-header: #202b36;
            --text-main: #2c3e50; --text-muted: #64748b;
            --accent: #2563eb; --accent-hover: #1d4ed8; 
            --border: #dce1e6; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --hl-dim: rgba(0, 0, 0, 0.05); 
            --hl-active: rgba(255, 235, 59, 0.5);
        }

        /* --- Layout --- */
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-body); color: var(--text-main); margin: 0; 
            display: flex; flex-direction: column; 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
        }
        
        /* --- Components --- */
        header { background: var(--bg-header); color: var(--text-light); padding: 0 15px; height: 50px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; border-bottom: 1px solid #1e293b; z-index: 10; }
        .branding { display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
        .branding:hover { opacity: 0.9; }
        .logo-text { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
        .nav-links { display: flex; gap: 10px; align-items: center; }
        .nav-link { color: var(--text-muted); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; display: flex; align-items: center; gap: 5px; }
        .nav-link:hover { color: var(--text-light); }
        .icon-btn { background: none; border: 1px solid transparent; color: inherit; font-size: 1.2rem; cursor: pointer; padding: 6px; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        .btn-fancy {
            display: flex; align-items: stretch; padding: 0; border: 1px solid var(--border); border-radius: var(--radius);
            background: var(--bg-panel); color: var(--text-main); cursor: pointer; transition: all 0.1s; overflow: hidden; height: 36px;
            user-select: none; min-width: 0;
        }
        .btn-fancy:hover { border-color: var(--accent); transform: translateY(-1px); }
        .btn-fancy:active { transform: translateY(0); }
        
        .btn-fancy-icon { width: 34px; background: rgba(125,125,125,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; border-right: 1px solid var(--border); flex-shrink: 0; }
        .btn-fancy-text { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.85rem; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary .btn-fancy-icon { background: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.1); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-success .btn-fancy-icon { background: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.1); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-danger:hover { filter: brightness(1.1); }
        
        .btn-sm { height: 28px; font-size: 0.8rem; }
        .btn-sm .btn-fancy-icon { width: 28px; font-size: 0.9rem; }
        
        .btn-square { width: 36px; padding: 0; justify-content: center; align-items: center; flex: 0 0 36px; }
        .btn-square.btn-sm { width: 28px; flex: 0 0 28px; }
        .btn-square .btn-fancy-icon { width: 100%; border: none; background: transparent; }
        
        .btn-floating { position: absolute; bottom: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: transform 0.2s; z-index: 10; }
        .btn-floating:hover { transform: scale(1.1); background: var(--accent-hover); }

        /* --- Panels --- */
        main { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        .panel-input { 
            width: 300px; min-width: 180px; max-width: 60%;
            background: var(--bg-panel); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; z-index: 5; flex-shrink: 0;
            resize: horizontal; overflow: hidden; 
        }
        .panel-header { padding: 8px 15px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); }
        .header-actions { display: flex; gap: 5px; }

        .input-container { position: relative; flex: 1; width: 100%; overflow: hidden; background: var(--bg-panel); }
        .input-backdrop, .input-textarea {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; margin: 0; padding: 15px; border: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5; letter-spacing: 0;
            white-space: pre-wrap; word-wrap: break-word; 
            background: transparent;
            overflow-y: scroll; box-sizing: border-box; 
        }
        .input-backdrop { z-index: 1; color: transparent; pointer-events: none; } 
        .input-textarea { z-index: 2; color: var(--text-main); resize: none; outline: none; }
        
        mark { color: transparent; border-radius: 2px; background: transparent; }
        .mode-overview mark { background: var(--hl-active); }
        .mode-ip mark.type-ip { background: var(--hl-active); }
        .mode-ip mark:not(.type-ip) { background: var(--hl-dim); }
        .mode-domain mark.type-domain { background: var(--hl-active); }
        .mode-domain mark:not(.type-domain) { background: var(--hl-dim); }
        .mode-hash mark.type-hash { background: var(--hl-active); }
        .mode-hash mark:not(.type-hash) { background: var(--hl-dim); }

        .panel-workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-body); min-width: 0; }
        .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 0 5px; overflow-x: auto; flex-shrink: 0; flex-wrap: wrap; }
        .tab { padding: 12px 15px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; white-space: nowrap; display: flex; align-items: center; gap: 8px; transition: color 0.2s; user-select: none; }
        .tab:hover { color: var(--accent); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .badge { background: var(--border); color: var(--text-main); font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; min-width: 16px; text-align: center; font-weight: 700; }
        .tab.active .badge { background: var(--accent); color: white; }

        .sources-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .sources-header { padding: 8px 15px; background: var(--bg-body); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; gap: 10px; height: 38px; }
        .sh-left { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; white-space: nowrap; }
        .sh-right { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding: 1px; }
        
        .sources-container { flex: 1; overflow-y: auto; padding: 20px; }
        .sources-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 10px; }
        
        /* Overview Dashboard */
        .overview-dashboard { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: start; }
        @media (min-width: 1350px) { .overview-dashboard { grid-template-columns: repeat(3, 1fr); } }

        .ov-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; max-height: 70vh; overflow: hidden; }
        .ov-header { padding: 8px 12px; border-bottom: 1px solid var(--border); font-weight: 600; background: rgba(0,0,0,0.02); display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-main); cursor: pointer; align-items: center; }
        .ov-header:hover { background: var(--bg-body); color: var(--accent); }
        .ov-content { padding: 0; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.8rem; color: var(--text-muted); flex: 1; }
        .ov-sub-title { padding: 4px 12px; font-size: 0.75rem; font-weight: 700; color: var(--text-main); background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); margin-top: -1px; }
        .ov-row { padding: 3px 12px; border-bottom: 1px dashed var(--border); display: flex; align-items: center; justify-content: space-between; min-height: 24px; }
        .ov-row:last-child { border-bottom: none; }
        .ov-val { overflow: hidden; white-space: pre-wrap; word-break: break-all; flex: 1; pointer-events: auto; }
        .ov-row.disabled { opacity: 0.6; }
        .ov-row.disabled .ov-val { text-decoration: line-through; color: var(--text-muted); pointer-events: none; user-select: none; }
        
        .ov-toggle-btn { width: 14px; height: 14px; border: 1px solid var(--border); border-radius: 50%; cursor: pointer; margin-left: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .ov-toggle-btn:hover { border-color: var(--accent); }
        .ov-toggle-btn::after { content: ""; width: 8px; height: 8px; border-radius: 50%; background: transparent; }
        .ov-row:not(.disabled) .ov-toggle-btn::after { background: var(--success); }
        .ov-row.disabled .ov-toggle-btn { border-color: var(--text-muted); opacity: 0.5; }
        
        /* Cards & Toolbar */
        .source-card { 
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius); height: 45px;
            padding: 0 8px; cursor: pointer; transition: all 0.1s; user-select: none; position: relative; 
            display: flex; align-items: center; justify-content: flex-start; text-align: left; overflow: hidden;
        }
        .source-card:hover { border-color: var(--accent); transform: translateY(-1px); }
        .source-card.selected { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); box-shadow: 0 0 0 1px var(--accent) inset; }
        .source-name { font-size: 0.85rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 5px; flex: 1; }
        .sc-indicator-lookup { position: absolute; top: 3px; right: 4px; font-size: 0.75rem; opacity: 0.7; }
        .sc-indicator-fav { position: absolute; bottom: 3px; right: 4px; font-size: 0.75rem; color: #3b82f6; } 
        
        .toolbar { padding: 0 15px; height: 48px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-sizing: border-box; }
        .toolbar-stats { display: flex; gap: 15px; font-size: 0.8rem; color: var(--text-muted); align-items: center; }
        .stat-item { display: flex; align-items: center; line-height: 1; }
        .stat-item span { color: var(--text-main); font-weight: 600; }
        .toolbar-actions { display: flex; gap: 8px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-panel); width: 90%; max-width: 650px; height: 526px; max-height: 90vh; border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.4); overflow: hidden; border: 1px solid var(--border); }
        .modal-header { padding: 12px 18px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; background: var(--bg-panel); color: var(--text-main); }
        .modal-header h2 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .modal-body { padding: 0; overflow-y: auto; flex: 1; display: flex; flex-direction: column; }
        
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 20px; background: var(--bg-body); overflow-x: auto; flex-shrink: 0; }
        .modal-tab { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; border-bottom: 2px solid transparent; color: var(--text-muted); white-space: nowrap; }
        .modal-tab.active { border-bottom-color: var(--accent); color: var(--accent); font-weight: 600; }
        .modal-tab-content { padding: 20px; display: none; overflow-y: auto; flex:1; }
        .modal-tab-content.active { display: block; }

        /* Investigation & Settings */
        .investigation-grid { display: grid; grid-template-columns: 2.5fr 1fr; height: 100%; overflow: hidden; }
        .inv-column { display: flex; flex-direction: column; overflow: hidden; height: 100%; border-right: 1px solid var(--border); }
        .inv-column:last-child { border-right: none; background: var(--bg-body); }
        .inv-column-header { padding: 8px 12px; background: var(--bg-body); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .inv-list { overflow-y: auto; flex: 1; padding: 0; }
        .inv-item { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; background: var(--bg-panel); border-left: 3px solid transparent; transition: opacity 0.2s; }
        .inv-item:hover { background: var(--bg-body); }
        .inv-item-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .inv-val { font-family: 'Consolas', monospace; font-weight: 600; color: var(--accent); font-size: 0.9rem; word-break: break-all; min-width: 0; }
        .inv-controls { display: flex; gap: 6px; align-items: center; }
        .verdict-select { padding: 4px; border-radius: 4px; border: 1px solid var(--border); font-size: 0.8rem; background: var(--bg-panel); color: var(--text-main); width: 130px; }
        .note-input { flex: 1; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; background: var(--bg-body); color: var(--text-main); min-width: 0; }
        .note-input:focus { border-color: var(--accent); outline: none; background: var(--bg-panel); }

        .manage-sources-container { display: flex; flex-direction: column; height: 100%; }
        .ms-list { border: 1px solid var(--border); border-radius: 4px; overflow-y: auto; flex: 1; background: var(--bg-panel); }
        .ms-item { display: grid; grid-template-columns: 1fr 100px; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .ms-fav { cursor: pointer; text-align: center; color: var(--border); transition: transform 0.2s; font-size: 1.1rem; opacity: 0.5; }
        .ms-fav:hover { transform: scale(1.2); opacity: 0.8; }
        .ms-fav.active { color: #3b82f6; opacity: 1; }
        .ms-tag { font-size: 0.7rem; padding: 1px 4px; border-radius: 4px; margin-left:5px; text-transform: uppercase; font-weight: 700; }
        .tag-custom { background: var(--accent); color: white; }
        .tag-lookup { background: var(--border); color: var(--text-muted); }
        .ms-actions-right { display:flex; align-items:center; gap:10px; justify-content: flex-end; }
        
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; overflow-x: auto; }
        .sub-tab { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-muted); transition: all 0.2s; white-space: nowrap; }
        .sub-tab:hover { border-color: var(--accent); }
        .sub-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        .toast { position: fixed; bottom: var(--toast-y); right: 25px; background: #333; color: white; padding: 12px 20px; border-radius: 6px; z-index: 2000; opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: #000; }

        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; vertical-align: middle; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .2s; border-radius: 20px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--accent); }
        input:checked + .toggle-slider:before { transform: translateX(16px); }

        .hidden { display: none !important; }
        .text-danger { color: var(--danger); }
        .text-muted { color: var(--text-muted); }
        .flex-gap { display: flex; gap: 10px; align-items: center; }
        
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 0.8rem; font-weight: 600; }
        .form-input, .form-select { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-panel); color: var(--text-main); box-sizing: border-box; font-size: 0.9rem; }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg-body); }
        .form-select-auto { width: auto; min-width: 120px; }
        .form-select-sm { width: auto; min-width: 50px; }
        
        select:disabled { opacity: 0.5; background-color: var(--bg-body); color: var(--text-muted); cursor: not-allowed; }

        .add-source-grid { display: grid; grid-template-columns: 0.5fr 1.5fr 100px; gap: 10px; }
        .add-source-full { grid-column: 1 / -1; margin-top: -5px; } 
        .settings-subheader { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin: 15px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }

        #report-content a { color: var(--accent); text-decoration: none; }
        #report-content a:hover { text-decoration: underline; }

        .report-controls-bar { padding: 10px 15px; background: var(--bg-body); border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.8rem; align-items: center; }
        .report-control-item { display:flex; gap:8px; align-items:center; }
        .report-control-label { margin:0; font-weight:500; }

        .backup-container { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-top: 20px; font-size: 0.85rem; display: none; }
        .backup-desc { margin-bottom: 10px; line-height: 1.4; color: var(--text-muted); }
        .backup-textarea { width: 100%; height: 80px; background: var(--bg-panel); color: var(--accent); border: 1px solid var(--border); font-family: monospace; padding: 8px; margin-bottom: 10px; font-size: 0.75rem; resize: vertical; }
        
        .close-modal { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; }

        /* --- MODERN SCROLLBARS (Global) --- */
        
        /* Works for Chrome, Edge, Safari */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--border); 
            border-radius: 5px; 
            border: 2px solid transparent; 
            background-clip: content-box; 
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-muted); 
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        /* Works for Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        /* --- CLEAN NATIVE RESIZER (Input Panel) --- */
        
        .panel-input::-webkit-resizer {
            background: transparent;
            border-style: solid;
            border-width: 6px; 
            border-color: transparent var(--border) var(--border) transparent; 
        }

        /* --- MEDIA QUERIES --- */

        @media (min-width: 901px) {
            .panel-input { height: auto !important; }
            .add-source-grid { grid-template-columns: 0.5fr 1.5fr 100px; }
        }

        @media (max-width: 900px) {
            main { flex-direction: column; }
            .panel-input { 
                width: 100% !important; max-width: 100%; 
                height: 20%; min-height: 80px; /* Resize enable */
                max-height: 60%; 
                border-right: none; border-bottom: 1px solid var(--border); 
                resize: vertical; 
            }
            .investigation-grid { grid-template-columns: 1fr; }
            .inv-column { border-right: none; border-bottom: 1px solid var(--border); }
            .inv-column:last-child { height: auto; max-height: 250px; flex: none; }
            .toolbar { height: auto; flex-wrap: wrap; gap: 10px; padding: 8px 15px; height: 50px; }
            .toolbar-stats { width: auto; gap: 10px; flex-shrink: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: 0.75rem; }
            .toolbar-actions { width: auto; flex-shrink: 0; }
            .btn-fancy { min-width: 0; }
            
            .add-source-grid { grid-template-columns: 1fr; }
            .add-source-full { margin-top: 0; }
            #add-btn-row { flex-direction: column-reverse; gap: 10px; align-items: stretch; }
            .tab { padding: 12px 8px; }
            .tabs { justify-content: flex-start; }
            .sources-container { padding: 15px; } 
            .sources-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); } 
            .ms-item { grid-template-columns: 1fr 90px; }
        }
        
        @media (max-width: 400px) {
            #sources-header .btn-fancy-text { display: none; }
            #sources-header .btn-fancy-icon { border-right: none; width: 100%; }
            #sources-header .btn-fancy { width: 36px; padding: 0; justify-content: center; }
        }
    </style>
</head>
<body>

<header>
    <div class="branding" id="branding-btn">
        <span style="font-size: 1.8rem;">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
        <div>
            <div class="logo-text">TotalOSINT</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">All-in-One Investigation Tool</div>
        </div>
    </div>
    <div class="nav-links">
        <a href="https://github.com/jhatzimalis/TotalOSINT" target="_blank" class="nav-link" title="GitHub Repo">
            <svg height="18" viewBox="0 0 16 16" width="18" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            GitHub
        </a>
        <button class="icon-btn" id="settings-btn" title="Settings">‚öôÔ∏è</button>
    </div>
</header>

<main>
    <!-- Left Panel: Input -->
    <div class="panel-input" id="panel-input">
        <div class="panel-header">
            <span>Investigation Notes</span>
            <div class="header-actions">
                <button class="btn-fancy btn-sm btn-square" id="copy-input-btn" title="Copy Notes">
                    <div class="btn-fancy-icon" style="width:100%; border:none;">üìã</div>
                </button>
                <button class="btn-fancy btn-sm btn-square" id="clear-input-btn" title="Clear Notes & Reset">
                    <div class="btn-fancy-icon" style="width:100%; border:none;">üóëÔ∏è</div>
                </button>
            </div>
        </div>
        <div class="input-container">
            <div class="input-backdrop mode-overview" id="input-backdrop"></div>
            <textarea class="input-textarea" id="raw-input" placeholder="Paste notes or logs here...&#10;TotalOSINT will extract IP Addresses, Domains, URLs, and File Hashes automatically."></textarea>
        </div>
    </div>

    <!-- Right Panel: Workspace -->
    <div class="panel-workspace">
        <div class="tabs">
            <div class="tab active" data-type="overview">‚ö° Overview</div>
            <div class="tab" data-type="ip">IP Address <span class="badge" id="count-ip">0</span></div>
            <div class="tab" data-type="domain">Domain / URL <span class="badge" id="count-domain">0</span></div>
            <div class="tab" data-type="hash">File Hash <span class="badge" id="count-hash">0</span></div>
            <div class="tab" data-type="bookmarks">Bookmarks</div>
        </div>

        <div class="sources-wrapper">
            <!-- Source Toolbar (Overview) -->
            <div class="sources-header hidden" id="overview-toolbar">
                <div class="sh-left">Dashboard</div>
                <div class="sh-right"></div>
            </div>

            <!-- Source Toolbar (Normal) -->
            <div class="sources-header hidden" id="sources-header">
                <div class="sh-left">Select Sources</div>
                <div class="sh-right">
                    <button class="btn-fancy btn-sm" id="select-all-btn" title="Select All Sources">
                        <div class="btn-fancy-icon">‚òëÔ∏è</div>
                        <div class="btn-fancy-text">All</div>
                    </button>
                    <button class="btn-fancy btn-sm" id="deselect-all-btn" title="Deselect All Sources">
                        <div class="btn-fancy-icon">‚¨ú</div>
                        <div class="btn-fancy-text">None</div>
                    </button>
                    <button class="btn-fancy btn-sm" id="sort-sources-btn" title="Sort Sources A-Z / Z-A">
                        <div class="btn-fancy-icon">üî§</div>
                        <div class="btn-fancy-text">Sort</div>
                    </button>
                    <button class="btn-fancy btn-sm" id="manage-sources-btn" title="Manage Sources">
                        <div class="btn-fancy-icon">‚öôÔ∏è</div>
                        <div class="btn-fancy-text">Manage</div>
                    </button>
                </div>
            </div>

            <div class="sources-container">
                <div id="overview-dashboard" class="overview-dashboard"></div>
                <div id="sources-grid" class="sources-grid hidden"></div>
                <div id="no-data-msg" class="hidden" style="text-align: center; color: var(--text-muted); display: flex; flex-direction: column; justify-content: flex-start; align-items: center; height: 100%; padding: 15vh 20px 0 20px;"></div>
            </div>
        </div>

        <div class="toolbar">
            <div class="toolbar-stats" id="toolbar-stats">
                <div class="stat-item" id="stat-item-entities">Entities:&nbsp;<span id="stat-entities">0</span></div>
                <div style="opacity:0.3" id="stat-separator">|</div>
                <div class="stat-item" id="stat-item-sources">Sources:&nbsp;<span id="stat-sources">0</span></div>
            </div>
            <div class="toolbar-actions hidden" id="toolbar-actions">
                <button class="btn-fancy btn-square" id="launch-modal-open-btn" style="flex: 0 0 36px;" title="Open All Sources">
                    <div class="btn-fancy-icon" style="border:none; width:100%;">üåê</div>
                </button>
                <button class="btn-fancy btn-primary" id="launch-modal-btn" style="flex: 0 0 auto; min-width: 140px;">
                    <div class="btn-fancy-icon">üöÄ</div>
                    <div class="btn-fancy-text" id="launch-btn-text">Investigate</div>
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Investigation Modal -->
<div class="modal-overlay" id="investigation-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>üîé Investigation Workbench</h2>
            <button class="icon-btn close-modal" style="color:var(--text-main); justify-self:end;">√ó</button>
        </div>
        <div class="modal-body">
            <div class="investigation-grid">
                <div class="inv-column">
                    <div class="inv-column-header">
                        <span>Extracted Entities (<span id="inv-entity-count">0</span>)</span>
                        <div class="flex-gap" style="font-size:0.8rem; text-transform:none; font-weight:normal;">
                             <label for="modal-defang">Defang</label>
                             <label class="toggle-switch"> 
                                <input type="checkbox" id="modal-defang"> 
                                <span class="toggle-slider"></span> 
                             </label>
                        </div>
                    </div>
                    <div class="inv-list" id="inv-entity-list"></div>
                </div>
                <div class="inv-column" style="background:var(--bg-body);">
                    <div class="inv-column-header">
                        <span id="inv-source-count-display">Target Sources (0)</span>
                    </div>
                    <div class="inv-list" id="inv-source-list" style="padding: 10px; max-height: 200px;"></div>
                    
                    <div style="padding: 15px; display:flex; flex-direction:column; gap:10px; border-top:1px solid var(--border); background:var(--bg-panel); flex:none; margin-top: auto;">
                        <button class="btn-fancy btn-primary" id="execute-btn">
                            <div class="btn-fancy-icon">üåê</div>
                            <div class="btn-fancy-text">Open All Sources</div>
                        </button>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-fancy" id="preview-report-btn" style="flex:1;">
                                <div class="btn-fancy-icon">üìú</div>
                                <div class="btn-fancy-text">Report</div>
                            </button>
                            <button class="btn-fancy btn-square" id="generate-report-btn" title="Copy Report">
                                <div class="btn-fancy-icon" style="width:100%; border:none;">üìã</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="preview-modal" style="z-index: 1100;">
    <div class="modal" style="max-width: 650px; height: 600px; position: relative;">
        <div class="modal-header">
            <h2 id="preview-title" style="margin:0; font-size:1.1rem;">Report</h2>
            
            <select class="form-select form-select-auto" id="preview-mode" style="padding:2px 6px; font-size:0.8rem; height: 26px; font-weight:600;">
                <option value="full">Full Report</option>
                <option value="simple">Simple List</option>
            </select>
            
            <button class="icon-btn close-modal" style="color:var(--text-main); justify-self: end;">√ó</button>
        </div>
        
        <div class="report-controls-bar">
             <div class="report-control-item">
                <span class="report-control-label">Defang</span>
                <label class="toggle-switch"> <input type="checkbox" id="preview-defang"> <span class="toggle-slider"></span> </label>
             </div>

             <div id="controls-full" style="display:contents;">
                 <div class="report-control-item">
                    <span class="report-control-label">Refs</span>
                    <label class="toggle-switch"> <input type="checkbox" id="preview-reference"> <span class="toggle-slider"></span> </label>
                 </div>
                 <div class="report-control-item">
                    <span class="report-control-label">Verdict</span>
                    <label class="toggle-switch"> <input type="checkbox" id="preview-verdict"> <span class="toggle-slider"></span> </label>
                 </div>
                 <div class="report-control-item" style="margin-left:auto;">
                    <span class="report-control-label">Space</span>
                    <label class="toggle-switch"> <input type="checkbox" id="preview-addspace"> <span class="toggle-slider"></span> </label>
                    <select class="form-select form-select-auto" id="preview-sep-type" style="padding:2px 6px; font-size:0.8rem; height: 26px;">
                        <option value="newline">Newline</option>
                        <option value="dash">Hyphen (-)</option>
                        <option value="eq">Equal (=)</option>
                        <option value="us">Underscore (_)</option>
                        <option value="comma">Comma</option>
                    </select>
                    <select class="form-select form-select-sm" id="preview-sep-len" style="padding:2px 6px; font-size:0.8rem; height: 26px;">
                        <option value="3">3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="75">75</option>
                    </select>
                 </div>
             </div>

             <div id="controls-simple" style="display:none; flex:1; justify-content:flex-end; gap:15px; align-items:center;">
                <div class="report-control-item">
                    <span class="report-control-label">Quotes</span>
                    <select class="form-select form-select-auto" id="preview-quotes" style="padding:2px 6px; font-size:0.8rem; height: 26px;">
                        <option value="none">None</option>
                        <option value="single">Single (')</option>
                        <option value="double">Double (")</option>
                    </select>
                </div>
                <div class="report-control-item">
                    <span class="report-control-label">List</span>
                    <select class="form-select form-select-auto" id="preview-list" style="padding:2px 6px; font-size:0.8rem; height: 26px;">
                        <option value="bullet-dash">Bullet (-)</option>
                        <option value="bullet-star">Bullet (*)</option>
                        <option value="newline">Newline</option>
                        <option value="comma">Comma</option>
                    </select>
                </div>
             </div>
        </div>

        <div class="modal-body" style="padding: 0; background: var(--bg-panel);">
             <div id="report-content" style="width:100%; height:100%; padding:20px; font-family:'Consolas', monospace; outline:none; overflow:auto; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.5; word-break: break-all;"></div>
             <button class="btn-floating" id="preview-copy-btn" title="Copy to Clipboard">üìã</button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal" style="max-width: 650px; height: 526px; max-height: 90vh;">
        <div class="modal-header">
            <h2>‚öôÔ∏è Settings</h2>
            <button class="icon-btn close-modal" style="color:var(--text-main); justify-self:end;">√ó</button>
        </div>
        <div class="modal-tabs">
            <div class="modal-tab active" data-tab="appearance">Appearance</div>
            <div class="modal-tab" data-tab="security">Security</div>
            <div class="modal-tab" data-tab="sources">Manage Sources</div>
        </div>

        <div class="modal-body">
            <!-- Appearance Tab -->
            <div id="tab-appearance" class="modal-tab-content active">
                <div class="settings-subheader">Application Theme</div>
                <div class="form-group">
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <div style="flex:1; border:2px solid var(--border); padding:15px; border-radius:8px; cursor:pointer; text-align:center; opacity:0.7;" id="theme-card-light" onclick="setTheme('light')">
                            <span style="font-size:2rem; display:block;">‚òÄÔ∏è</span>Light Mode
                        </div>
                        <div style="flex:1; border:2px solid var(--border); padding:15px; border-radius:8px; cursor:pointer; text-align:center; opacity:0.7;" id="theme-card-dark" onclick="setTheme('dark')">
                            <span style="font-size:2rem; display:block;">üåô</span>Dark Mode
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
             <div id="tab-security" class="modal-tab-content">
                <div class="settings-subheader">Security</div>
                <div class="form-group">
                    <label>Global De-fang</label>
                    <div class="flex-gap">
                        <label class="toggle-switch"> <input type="checkbox" id="setting-defang"> <span class="toggle-slider"></span> </label>
                        <span style="font-size:0.85rem; color:var(--text-muted);">Replace <code>.</code> with <code>[.]</code>, <code>http</code> with <code>hxxp</code>, etc.</span>
                    </div>
                </div>
            </div>

            <!-- Manage Sources Tab -->
            <div id="tab-sources" class="modal-tab-content">
                <div class="manage-sources-container">
                    <div id="add-source-form-container" style="background: var(--bg-body); padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 15px; display:none;">
                        <div class="add-source-grid">
                            <div class="form-group">
                                <label>ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-input" id="cs-id" placeholder="ID" style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label>Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-input" id="cs-name" placeholder="Tool Name">
                            </div>
                             <div class="form-group">
                                <label>Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="cs-type" style="width: 100%;">
                                    <option value="ip">IP</option>
                                    <option value="domain">Domain</option>
                                    <option value="hash">Hash</option>
                                    <option value="bookmarks">Bookmark</option>
                                </select>
                            </div>
                            <div class="form-group add-source-full">
                                <label>Home URL <span class="text-danger">*</span></label>
                                <input type="text" class="form-input" id="cs-home" placeholder="https://tool.com">
                            </div>
                            <div class="form-group add-source-full">
                                <label>Lookup URL (Optional)</label>
                                <input type="text" class="form-input" id="cs-lookup" placeholder="https://tool.com/search?q=">
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:5px; justify-content: space-between;">
                            <div style="display:flex; gap:10px;">
                                <button class="btn-fancy btn-success" id="save-custom-source-btn" style="height:32px;">
                                    <div class="btn-fancy-icon">üíæ</div>
                                    <div class="btn-fancy-text" id="add-source-text">Save Source</div>
                                </button>
                                <button class="btn-fancy" id="cancel-edit-btn" style="height:32px; width:80px; flex:none;">
                                    <div class="btn-fancy-text">Cancel</div>
                                </button>
                            </div>
                            <button class="btn-fancy btn-danger hidden" id="delete-custom-source-btn" style="height:32px; width:40px; justify-content:center;">
                                <div style="font-size:1.2rem;">üóëÔ∏è</div>
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;" id="add-btn-row">
                        <div class="sub-tabs" style="margin:0; border:none; padding:0;">
                            <div class="sub-tab active" onclick="filterManageSources('all')">All</div>
                            <div class="sub-tab" onclick="filterManageSources('ip')">IP</div>
                            <div class="sub-tab" onclick="filterManageSources('domain')">Domain/URL</div>
                            <div class="sub-tab" onclick="filterManageSources('hash')">Hash</div>
                            <div class="sub-tab" onclick="filterManageSources('bookmarks')">Bookmarks</div>
                        </div>
                        <button class="btn-fancy btn-sm" id="show-add-form-btn">
                            <div class="btn-fancy-icon">‚ûï</div>
                            <div class="btn-fancy-text">Add Source</div>
                        </button>
                    </div>
                    
                    <div class="ms-list" id="manage-sources-list"></div>

                    <div style="text-align: right; margin-top: 10px;">
                        <a href="javascript:void(0)" id="backup-toggle-link" onclick="openBackupUI()" style="font-size:0.75rem; color:var(--text-muted); text-decoration:none;">Advanced / Backup</a>
                    </div>
                    
                    <div id="backup-ui" class="backup-container">
                        <div style="font-weight:700; margin-bottom:5px;">Backup & Restore</div>
                        <div class="backup-desc">
                            Save your custom sources and favorites to a local text file. <br>
                            If you ever lose your local storage, you can use this to restore.
                        </div>
                        <textarea id="backup-text" class="backup-textarea" placeholder="Paste JSON here to restore..."></textarea>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-fancy btn-sm" id="btn-do-backup-copy">
                                <div class="btn-fancy-icon">üìã</div>
                                <div class="btn-fancy-text">Copy</div>
                            </button>
                            <button class="btn-fancy btn-sm btn-primary" id="btn-do-restore">
                                <div class="btn-fancy-icon">üîÑ</div>
                                <div class="btn-fancy-text">Restore</div>
                            </button>
                            <button class="btn-fancy btn-sm" onclick="closeBackupUI()">
                                <div class="btn-fancy-text">Cancel</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- Data -->
<script src="sources.js"></script>
<script>
    if (typeof sources === 'undefined') {
        window.sources = {
            ip: [ { id: 'AIPDB', name: 'AbuseIPDB', url: 'https://www.abuseipdb.com/', lookupurl: 'https://www.abuseipdb.com/check/' }, { id: 'IPQS', name: 'IPQualityScore', url: 'https://www.ipqualityscore.com/', lookupurl: 'https://www.ipqualityscore.com/vpn-ip-address-check/lookup/' }, { id: 'VT', name: 'VirusTotal', url: 'https://www.virustotal.com/', lookupurl: 'https://www.virustotal.com/gui/ip-address/' }, { id: 'GGL', name: 'Google Search', url: 'https://google.com', lookupurl: 'https://google.com/search?q=' } ],
            domain: [ { id: 'URLSCAN', name: 'urlscan.io', url: 'https://urlscan.io/', lookupurl: 'https://urlscan.io/search/#' }, { id: 'BRWLR', name: 'Browserling', url: 'https://www.browserling.com/', lookupurl: 'https://www.browserling.com/browse/win10/chrome127/' }, { id: 'VT', name: 'VirusTotal', url: 'https://www.virustotal.com/', lookupurl: 'https://www.virustotal.com/gui/domain/' }, { id: 'GGL', name: 'Google Search', url: 'https://google.com', lookupurl: 'https://google.com/search?q=' } ],
            hash: [ { id: 'VT', name: 'VirusTotal', url: 'https://www.virustotal.com/', lookupurl: 'https://www.virustotal.com/gui/file/' }, { id: 'ARUN', name: 'Any.Run', url: 'https://app.any.run/', lookupurl: 'https://app.any.run/submissions/sample/' }, { id: 'HYBAN', name: 'Hybrid Analysis', url: 'https://www.hybrid-analysis.com', lookupurl: 'https://www.hybrid-analysis.com/sample/' } ],
            bookmarks: [ { id: 'GGADV', name: 'Google Adv Search', url: 'https://www.google.com/advanced_search' }, { id: 'HIBP', name: 'Have I Been Pwned', url: 'https://haveibeenpwned.com/' }, { id: 'OSFMW', name: 'OSINT Framework', url: 'https://osintframework.com/' }, { id: 'GOOS', name: 'Goosint', url: 'https://goosint.com/' }, { id: 'CYCHF', name: 'CyberChef', url: 'https://gchq.github.io/CyberChef/' } ]
        };
    }
</script>

<script>
    /* --- APP STATE --- */
    const app = {
        data: { ip: [], domain: [], hash: [] },
        selectedSources: { ip: [], domain: [], hash: [], bookmarks: [] },
        currentTab: 'overview',
        manageFilter: 'all',
        customSources: [],
        favorites: [],
        verdicts: {},
        disabledEntities: {}, 
        sortDesc: false, 
        settings: { 
            theme: 'dark', defang: true, sepType: 'newline', sepLen: '3', addSpace: false, 
            showReference: true, showVerdict: true, 
            reportMode: 'full', quoteType: 'none', listType: 'bullet-dash' 
        },
        debounceTimer: null,
        editingId: null,
        tempReport: ''
    };

    const HTML_WELCOME = `
        <div style="font-size: 3rem; margin-bottom: 10px; opacity:0.8;">üîé</div>
        <div style="font-size: 0.9rem; font-weight:500; margin-bottom: 8px; line-height: 1.5; color: var(--text-muted); opacity: 0.6;">Paste investigation notes<br>or continue to another tab.</div>
    `;

    /* --- DOM ELEMENTS --- */
    const els = {
        input: document.getElementById('raw-input'),
        backdrop: document.getElementById('input-backdrop'),
        grid: document.getElementById('sources-grid'),
        sourcesHeader: document.getElementById('sources-header'),
        ovHeader: document.getElementById('overview-toolbar'),
        dashboard: document.getElementById('overview-dashboard'),
        msg: document.getElementById('no-data-msg'),
        tabs: document.querySelectorAll('.tab'),
        counts: { ip: document.getElementById('count-ip'), domain: document.getElementById('count-domain'), hash: document.getElementById('count-hash') },
        stats: { ent: document.getElementById('stat-entities'), src: document.getElementById('stat-sources'), itemEnt: document.getElementById('stat-item-entities'), itemSrc: document.getElementById('stat-item-sources'), sep: document.getElementById('stat-separator') },
        toolbarActions: document.getElementById('toolbar-actions'),
        launchBtns: { modal: document.getElementById('launch-modal-btn'), direct: document.getElementById('launch-modal-open-btn'), text: document.getElementById('launch-btn-text') },
        modals: { inv: document.getElementById('investigation-modal'), settings: document.getElementById('settings-modal'), preview: document.getElementById('preview-modal') }
    };

    /* --- INITIALIZATION --- */
    function init() {
        if (typeof sources !== 'undefined') window.sources = sources;
        loadSettings();
        mergeSources();
        setupEvents();
        els.input.value = ''; 
        els.input.focus();
        renderOverview(); 
        switchTab('overview');
    }

    function loadSettings() {
        const s = localStorage.getItem('totalosint_settings');
        if(s) app.settings = {...app.settings, ...JSON.parse(s)};
        setTheme(app.settings.theme);
        
        syncSettingsUI();

        const cs = localStorage.getItem('totalosint_custom_sources');
        if(cs) app.customSources = JSON.parse(cs);

        const fav = localStorage.getItem('totalosint_favorites');
        if(fav) app.favorites = JSON.parse(fav);
    }

    function syncSettingsUI() {
        document.getElementById('setting-defang').checked = app.settings.defang;
        document.getElementById('modal-defang').checked = app.settings.defang;
        document.getElementById('preview-defang').checked = app.settings.defang;
        document.getElementById('preview-reference').checked = app.settings.showReference;
        document.getElementById('preview-verdict').checked = app.settings.showVerdict;
        document.getElementById('preview-sep-type').value = app.settings.sepType;
        document.getElementById('preview-sep-len').value = app.settings.sepLen;
        document.getElementById('preview-addspace').checked = app.settings.addSpace;
        
        document.getElementById('preview-mode').value = app.settings.reportMode;
        document.getElementById('preview-quotes').value = app.settings.quoteType;
        document.getElementById('preview-list').value = app.settings.listType;

        const entities = (app.data[app.currentTab] || []).filter(e => !app.disabledEntities[e.val]);
        const forceSimple = (entities.length === 0);
        
        const isSimple = app.settings.reportMode === 'simple' || forceSimple;
        document.getElementById('controls-full').style.display = isSimple ? 'none' : 'contents';
        document.getElementById('controls-simple').style.display = isSimple ? 'flex' : 'none';

        toggleReportDropdown();
    }

    function saveSettings() { localStorage.setItem('totalosint_settings', JSON.stringify(app.settings)); }
    function saveFavorites() { localStorage.setItem('totalosint_favorites', JSON.stringify(app.favorites)); }
    
    function setTheme(theme) {
        app.settings.theme = theme;
        if(theme === 'light') document.body.classList.add('theme-light');
        else document.body.classList.remove('theme-light');
        document.getElementById('theme-card-light').style.opacity = theme === 'light' ? '1' : '0.6';
        document.getElementById('theme-card-light').style.borderColor = theme === 'light' ? 'var(--accent)' : 'var(--border)';
        document.getElementById('theme-card-dark').style.opacity = theme === 'dark' ? '1' : '0.6';
        document.getElementById('theme-card-dark').style.borderColor = theme === 'dark' ? 'var(--accent)' : 'var(--border)';
        saveSettings();
    }

    function mergeSources() {
        app.customSources.forEach(cs => {
            if(window.sources[cs.type] && !window.sources[cs.type].find(x => x.id === cs.id)) window.sources[cs.type].push(cs);
        });
    }

    function clearNotes() {
        els.input.value = '';
        els.input.focus();
        analyzeInput();
    }
    
    function softReset() {
        clearNotes();
        closeSourceForm();
        app.data = { ip: [], domain: [], hash: [] };
        app.verdicts = {};
        app.disabledEntities = {};
        renderOverview();
        switchTab('overview');
    }

    /* --- ANALYSIS --- */
    const R = {
        ipv4: /\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\.|\[\.\]|\(\.\))){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/g,
        ipv6: /((?:[0-9a-fA-F]{1,4}(?::|\[:\])){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}(?::|\[:\])){1,7}(?::|\[:\])(?:[0-9a-fA-F]{1,4}(?:(?::|\[:\])[0-9a-fA-F]{1,4})*)?|::(?:[0-9a-fA-F]{1,4}(?:(?::|\[:\])[0-9a-fA-F]{1,4})*)?)/g,
        url: /h(?:tt|xx)ps?(?::|\[:\])\/\/(?:[a-zA-Z0-9.\-]|\[\.\]|\(\.\))+\.(?:[a-zA-Z]{2,}|\[\.\][a-zA-Z]{2,}|\(\.\)[a-zA-Z]{2,})(?:\/[^\s<>"']*)?/g,
        domain: /(?<![\w@\.\-\/])\b(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.|\[\.\]|\(\.\)))+[a-z]{2,63}\b/gi,
        hash: /\b[a-fA-F0-9]{32}\b|\b[a-fA-F0-9]{40}\b|\b[a-fA-F0-9]{64}\b/g
    };

    function onInputChanged() {
        clearTimeout(app.debounceTimer);
        generateHighlights(); 
        app.debounceTimer = setTimeout(analyzeInput, 600);
    }

    function cleanInput(val) {
        if(!val) return val;
        let s = val.replace(/\[\.\]/g, '.').replace(/\(\.\)/g, '.');
        s = s.replace(/\[:\]/g, ':');
        s = s.replace(/hxxp/gi, 'http');
        s = s.replace(/\[\:\/\/\]/g, '://');
        return s;
    }

    function analyzeInput() {
        const text = els.input.value;
        app.data = { ip: [], domain: [], hash: [] };
        
        if(!text.trim()) {
            ['ip','domain','hash'].forEach(k => els.counts[k].innerText = 0);
            renderOverview();
            generateHighlights(); 
            return;
        }

        let rawURLs = text.match(R.url) || [];
        rawURLs = rawURLs.map(u => u.replace(/[.,;?!:)"'\]>]+$/, ""));

        const rawIPv6s = text.match(R.ipv6) || [];
        const rawIPv4s = text.match(R.ipv4) || [];
        const rawHashes = text.match(R.hash) || [];
        const rawDomains = text.match(R.domain) || [];

        // Identify domains that are already covered by URLs
        const domainsInUrls = new Set();
        const urlSet = new Set(rawURLs);
        urlSet.forEach(u => {
            const cleanU = cleanInput(u);
            app.data.domain.push({ val: cleanU, type: 'URL' });
            try {
                const urlObj = new URL(cleanU.startsWith('http') ? cleanU : 'http://' + cleanU); 
                const host = urlObj.hostname;
                if (host) {
                    domainsInUrls.add(host);
                    domainsInUrls.add(host.replace(/^www\./, ''));
                }
            } catch(e) {}
        });

        [...new Set(rawDomains)].forEach(d => {
             const cleanD = cleanInput(d);
             if(cleanD.match(/^\d+\.\d+\.\d+\.\d+$/)) return;
             if(domainsInUrls.has(cleanD) || domainsInUrls.has(cleanD.replace(/^www\./, ''))) return;
             app.data.domain.push({ val: cleanD, type: 'Domain' });
        });

        [...new Set(rawIPv6s)].forEach(ip => app.data.ip.push({ val: cleanInput(ip), type: 'IPv6' }));
        [...new Set(rawIPv4s)].forEach(ip => app.data.ip.push({ val: cleanInput(ip), type: 'IPv4' }));
        
        [...new Set(rawHashes)].forEach(h => {
            let t = 'Hash';
            if(h.length === 32) t = 'MD5';
            else if(h.length === 40) t = 'SHA-1';
            else if(h.length === 64) t = 'SHA-256';
            app.data.hash.push({ val: h, type: t });
        });
        
        app.data.domain = removeDuplicates(app.data.domain);
        app.data.ip = removeDuplicates(app.data.ip);
        app.data.hash = removeDuplicates(app.data.hash);

        const sorter = (a, b) => a.val.localeCompare(b.val, undefined, { numeric: true });
        app.data.ip.sort(sorter);
        app.data.domain.sort(sorter);
        app.data.hash.sort(sorter);

        updateCounts();
        if(app.currentTab === 'overview') renderOverview();
        updateUI();
        generateHighlights(); 
    }

    function applyDefang(val) {
        if(!app.settings.defang) return val;
        let s = val;
        s = s.replace(/http/gi, 'hxxp');
        s = s.replace(/:\/\//g, '___SCHEME___');
        if (s.includes('.')) s = s.replace(/\./g, '[.]');
        if (s.includes(':')) s = s.replace(/:/g, '[:]'); 
        s = s.replace(/___SCHEME___/g, '[://]');
        s = s.replace(/\[\[\.\]\]/g, '[.]');
        return s;
    }

    function removeDuplicates(arr) {
        const unique = new Set();
        return arr.filter(item => {
            const key = item.val + '|' + item.type;
            if(unique.has(key)) return false;
            unique.add(key);
            return true;
        });
    }

    function updateCounts() {
        const filter = (arr) => arr.filter(x => !app.disabledEntities[x.val]).length;
        els.counts.ip.innerText = filter(app.data.ip);
        els.counts.domain.innerText = filter(app.data.domain);
        els.counts.hash.innerText = filter(app.data.hash);
        const total = filter(app.data.ip) + filter(app.data.domain) + filter(app.data.hash);
        els.stats.ent.innerText = total;
    }

    function renderOverview() {
        const dash = els.dashboard;
        const totalItems = app.data.ip.length + app.data.domain.length + app.data.hash.length;

        if(totalItems === 0) {
             dash.style.display = 'none';
             els.msg.innerHTML = HTML_WELCOME;
             els.msg.classList.remove('hidden');
             return;
        }

        dash.style.display = 'grid';
        els.msg.classList.add('hidden');
        dash.innerHTML = '';

        ['ip','domain','hash'].forEach(key => {
             const items = app.data[key];
             if(items.length === 0) return;
             const activeCount = items.filter(x => !app.disabledEntities[x.val]).length;
             const subgroups = {};
             items.forEach(i => {
                if(!subgroups[i.type]) subgroups[i.type] = [];
                subgroups[i.type].push(i.val);
             });

             const card = document.createElement('div');
             card.className = 'ov-card';
             card.innerHTML = `<div class="ov-header" onclick="switchTab('${key}')"><span>${key === 'ip' ? 'IP Address' : key === 'domain' ? 'Domain / URL' : 'File Hash'}</span> <span>${activeCount} ‚ûî</span></div>`;
             
             const content = document.createElement('div');
             content.className = 'ov-content';
             
             Object.keys(subgroups).sort().forEach(subKey => {
                content.innerHTML += `<div class="ov-sub-title">${subKey}</div>`;
                subgroups[subKey].forEach(val => {
                    const isDisabled = app.disabledEntities[val];
                    const row = document.createElement('div');
                    row.className = `ov-row ${isDisabled ? 'disabled' : ''}`;
                    const displayVal = applyDefang(val);
                    const safeVal = displayVal.replace(/"/g, '&quot;');
                    
                    row.innerHTML = `
                        <span class="ov-val" title="${safeVal}">${safeVal}</span>
                        <div class="ov-toggle-btn" onclick="toggleEntityDisable('${val.replace(/'/g, "\\'")}')" title="${isDisabled ? 'Enable' : 'Disable'}"></div>
                    `;
                    content.appendChild(row);
                });
             });
             card.appendChild(content);
             dash.appendChild(card);
        });
    }

    window.toggleEntityDisable = (ent) => {
        app.disabledEntities[ent] = !app.disabledEntities[ent];
        updateCounts(); 
        renderOverview(); 
        generateHighlights(); 
        updateUI();
    };

    function generateHighlights() {
        let text = els.input.value;
        if(!text) { els.backdrop.innerHTML = ''; return; }
        text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        const wrap = (t, rx, cls) => t.replace(rx, m => {
            let clean = cleanInput(m);
            if(app.disabledEntities[clean]) return m; 
            return `<mark class="${cls}">${m}</mark>`;
        });
        
        text = wrap(text, R.hash, 'type-hash');
        text = wrap(text, R.url, 'type-domain'); 
        text = wrap(text, R.domain, 'type-domain'); 
        text = wrap(text, R.ipv6, 'type-ip');
        text = wrap(text, R.ipv4, 'type-ip');
        els.backdrop.innerHTML = text.replace(/\n/g, '<br>') + '<br>';
    }

    function syncScroll() { els.backdrop.scrollTop = els.input.scrollTop; }

    function switchTab(type) {
        app.currentTab = type;
        els.tabs.forEach(t => t.classList.toggle('active', t.dataset.type === type));
        
        const isOverview = type === 'overview';
        els.sourcesHeader.classList.toggle('hidden', isOverview);
        els.ovHeader.classList.toggle('hidden', !isOverview);
        els.backdrop.className = `input-backdrop mode-${type}`;

        els.dashboard.style.display = 'none';
        els.grid.classList.add('hidden');
        els.toolbarActions.classList.add('hidden');
        els.msg.classList.add('hidden');

        if (type === 'overview') {
            renderOverview(); 
        } else {
            els.grid.classList.remove('hidden');
            if (type === 'bookmarks') {
                els.toolbarActions.classList.remove('hidden');
                els.launchBtns.modal.classList.add('hidden'); 
                els.launchBtns.direct.title = "Open All Sources"; 
                renderSources();
            } else {
                els.toolbarActions.classList.remove('hidden');
                els.launchBtns.modal.classList.remove('hidden');
                els.launchBtns.direct.title = "Open All Sources"; 
                renderSources();
            }
        }
        updateUI();
    }

    function renderSources() {
        const list = window.sources[app.currentTab] || [];
        list.sort((a,b) => app.sortDesc ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name));

        els.grid.innerHTML = '';
        list.forEach(src => {
            const isSel = app.selectedSources[app.currentTab].includes(src.id);
            const isFav = app.favorites.includes(src.id);
            
            const el = document.createElement('div');
            el.className = `source-card ${isSel ? 'selected' : ''}`;
            el.title = src.name; 
            
            let html = `<span class="source-name">${src.name}</span>`;
            if(src.lookupurl) html += `<div class="sc-indicator-lookup">üîç</div>`;
            if(isFav) html += `<div class="sc-indicator-fav">üíô</div>`;

            el.innerHTML = html;
            el.onclick = () => toggleSource(src.id);
            els.grid.appendChild(el);
        });
    }

    function toggleSource(id) {
        const arr = app.selectedSources[app.currentTab];
        const idx = arr.indexOf(id);
        if (idx > -1) arr.splice(idx, 1);
        else arr.push(id);
        renderSources();
        updateUI();
    }

    function updateUI() {
        const tab = app.currentTab;
        const srcCount = app.selectedSources[tab]?.length || 0;
        const activeTotal = (app.data.ip.filter(x=>!app.disabledEntities[x.val]).length) + 
                          (app.data.domain.filter(x=>!app.disabledEntities[x.val]).length) + 
                          (app.data.hash.filter(x=>!app.disabledEntities[x.val]).length);
        const entCount = (tab === 'bookmarks' || tab === 'overview') ? activeTotal : (app.data[tab] || []).filter(x => !app.disabledEntities[x.val]).length || 0;

        els.stats.ent.innerText = entCount;
        els.stats.src.innerText = srcCount;
        
        const showStats = tab !== 'overview' && tab !== 'bookmarks';
        els.stats.itemEnt.classList.toggle('hidden', !showStats && tab !== 'overview');
        els.stats.itemSrc.classList.toggle('hidden', tab === 'overview');
        els.stats.sep.classList.toggle('hidden', tab === 'overview' || tab === 'bookmarks');
    }

    function openInvestigation() {
        const tab = app.currentTab;
        if(tab === 'overview' || tab === 'bookmarks') return;

        const sourceIds = app.selectedSources[tab];
        if (sourceIds.length === 0) return toast("Select at least one source.", "error");
        
        renderInvestigationList();

        const srcList = document.getElementById('inv-source-list');
        srcList.innerHTML = '';
        const activeSrc = window.sources[tab].filter(s => sourceIds.includes(s.id));
        document.getElementById('inv-source-count-display').innerText = `Target Sources (${activeSrc.length})`;
        activeSrc.forEach(s => {
            srcList.innerHTML += `<div style="font-size:0.8rem; padding:3px 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">‚Ä¢ ${s.name}</div>`;
        });

        els.modals.inv.classList.add('open');
    }

    function renderInvestigationList() {
        const tab = app.currentTab;
        if(!app.data[tab]) return;
        const entities = app.data[tab].filter(e => !app.disabledEntities[e.val]);
        
        if(entities.length === 0) {
            document.getElementById('inv-entity-count').innerText = 0;
            document.getElementById('inv-entity-list').innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted);">No entities.</div>`;
        } else {
            document.getElementById('inv-entity-count').innerText = entities.length;
            const list = document.getElementById('inv-entity-list');
            list.innerHTML = '';

            entities.forEach(entObj => {
                const ent = entObj.val;
                if(!app.verdicts[ent]) app.verdicts[ent] = { status: 'Untriaged', note: '' };
                const v = app.verdicts[ent];
                const displayEnt = applyDefang(ent);
                
                const div = document.createElement('div');
                div.className = `inv-item`;
                div.innerHTML = `
                    <div class="inv-item-header">
                        <span class="inv-val" title="${ent}">${displayEnt}</span>
                        <div class="flex-gap" style="gap:5px;">
                            <button class="icon-btn" title="Copy" style="font-size:0.9rem;" onclick="copyToClip('${displayEnt}', 'Copied!')">üìã</button>
                        </div>
                    </div>
                    <div class="inv-controls">
                        <select class="verdict-select" onchange="updateVerdict('${ent}', 'status', this.value)">
                            <option value="Untriaged" ${v.status === 'Untriaged'?'selected':''}>Untriaged</option>
                            <option value="Unknown" ${v.status === 'Unknown'?'selected':''}>‚ùì Unknown</option>
                            <option value="Clean" ${v.status === 'Clean'?'selected':''}>‚úÖ Clean</option>
                            <option value="Low-Suspicion" ${v.status === 'Low-Suspicion'?'selected':''}>üü° Low-Suspicion</option>
                            <option value="Suspicious" ${v.status === 'Suspicious'?'selected':''}>‚ö†Ô∏è Suspicious</option>
                            <option value="Malicious" ${v.status === 'Malicious'?'selected':''}>‚õî Malicious</option>
                        </select>
                        <input type="text" class="note-input" placeholder="Notes..." value="${v.note}" oninput="updateVerdict('${ent}', 'note', this.value)">
                    </div>
                `;
                list.appendChild(div);
            });
        }
    }

    function executeInvestigation() {
        const tab = app.currentTab;
        const sourceIds = app.selectedSources[tab];
        
        if(tab === 'bookmarks') {
            const allSrcs = window.sources.bookmarks || [];
            const selected = allSrcs.filter(s => sourceIds.includes(s.id));
            if(selected.length === 0) return toast("No bookmarks selected.", "error");
            if(selected.length > 10 && !confirm(`Open ${selected.length} tabs?`)) return;
            selected.forEach(s => window.open(s.url, '_blank'));
            return;
        }

        let entities = (app.data[tab] || []).filter(e => !app.disabledEntities[e.val]);
        if(entities.length === 0) entities = [{val: ''}];

        if(sourceIds.length === 0) return toast("Select sources first.", "error");

        let urls = [];
        entities.forEach(obj => {
            const ent = obj.val;
            window.sources[tab].filter(s => sourceIds.includes(s.id)).forEach(src => {
                let target = src.url;
                if (ent && ent.trim() !== '' && src.lookupurl && src.lookupurl.trim() !== '') {
                    target = src.lookupurl + encodeURIComponent(ent);
                }
                urls.push(target);
            });
        });

        urls = [...new Set(urls)];
        if(urls.length > 20 && !confirm(`Open ${urls.length} tabs?`)) return;
        urls.forEach(u => window.open(u, '_blank'));
    }

    function getSeparator() {
        const type = app.settings.sepType;
        const len = parseInt(app.settings.sepLen) || 3;
        const charMap = { 'dash': '-', 'eq': '=', 'us': '_' };
        let char = charMap[type];

        if(type === 'newline') return app.settings.addSpace ? '\n\n\n\n' : '\n\n';
        if(type === 'comma') return app.settings.addSpace ? '\n\n,\n\n' : '\n,\n'; 

        let line = char.repeat(len);
        if(app.settings.addSpace) return `\n\n${line}\n\n`;
        return `\n${line}\n`;
    }

    function buildReportText(forHtml = false) {
        const entities = (app.data[app.currentTab] || []).filter(e => !app.disabledEntities[e.val]);
        const sourceIds = app.selectedSources[app.currentTab];
        const activeSources = window.sources[app.currentTab].filter(s => sourceIds.includes(s.id));
        
        // No Entities Fallback
        if (entities.length === 0) {
            if (activeSources.length === 0) return "No entities or sources selected.";
            
            const list = activeSources.map(s => s.url);
            let report = "Target Sources:\n";
            const qMap = { 'none': '', 'single': "'", 'double': '"' };
            const q = qMap[app.settings.quoteType] || '';
            const listType = app.settings.listType;

            if (listType === 'comma') {
                if(forHtml) {
                    report += list.map(val => `${q}###LINK###${val}###LINK###${q}`).join(', ');
                } else {
                    report += list.map(val => `${q}${val}${q}`).join(', ');
                }
            } else {
                list.forEach(val => {
                    let prefix = "";
                    if(listType === 'bullet-dash') prefix = "- ";
                    if(listType === 'bullet-star') prefix = "* ";
                    
                    if(forHtml) report += `${prefix}${q}###LINK###${val}###LINK###${q}\n`;
                    else report += `${prefix}${q}${val}${q}\n`;
                });
            }
            return report.trim();
        }

        // Simple Mode
        if (app.settings.reportMode === 'simple') {
            const groups = {};
            entities.forEach(obj => {
                if(!groups[obj.type]) groups[obj.type] = [];
                groups[obj.type].push(obj.val);
            });

            let report = "";
            const qMap = { 'none': '', 'single': "'", 'double': '"' };
            const q = qMap[app.settings.quoteType] || '';
            
            Object.keys(groups).sort().forEach(type => {
                report += `${type}s:\n`;
                const list = groups[type];
                const listType = app.settings.listType;
                
                if (listType === 'comma') {
                    const line = list.map(val => `${q}${applyDefang(val)}${q}`).join(', ');
                    report += line + "\n\n";
                } else {
                    list.forEach(val => {
                        const cleanVal = applyDefang(val);
                        let prefix = "";
                        if(listType === 'bullet-dash') prefix = "- ";
                        if(listType === 'bullet-star') prefix = "* ";
                        report += `${prefix}${q}${cleanVal}${q}\n`;
                    });
                    report += "\n";
                }
            });
            return report.trim();
        }

        // Full Mode
        let report = "";
        const sep = getSeparator();
        const showRefs = app.settings.showReference && activeSources.length > 0;
        const showVerdict = app.settings.showVerdict; 

        entities.forEach((obj, i) => {
            const ent = obj.val;
            const v = app.verdicts[ent] || { status: 'Untriaged', note: '' };
            const displayEnt = applyDefang(ent);
            
            report += `${obj.type}: ${displayEnt}\n`;
            
            if(showVerdict) {
                report += `Verdict: ${v.status}\n`;
            }
            if(v.note) report += `Note: ${v.note}\n`;
            
            if(showRefs) {
                if(activeSources.length === 1) {
                    let src = activeSources[0];
                    let url = src.url;
                    if(ent && ent.trim() !== '' && src.lookupurl && src.lookupurl.trim() !== '') {
                        url = src.lookupurl + encodeURIComponent(ent);
                    }
                    if(forHtml) report += `References: ###LINK###${url}###LINK###`;
                    else report += `References: ${url}`;
                } else {
                    report += `References:`;
                    activeSources.forEach(src => {
                        let url = src.url;
                        if(ent && ent.trim() !== '' && src.lookupurl && src.lookupurl.trim() !== '') {
                            url = src.lookupurl + encodeURIComponent(ent);
                        }
                        if(forHtml) report += `\n###LINK###${url}###LINK###`;
                        else report += `\n${url}`;
                    });
                }
            } else {
                report = report.trimEnd();
            }
            
            if(i < entities.length - 1) report += sep;
        });
        return report;
    }

    function generateReport() {
        const report = buildReportText(false);
        if(!report) return toast("No entities to report.", "warning");
        copyToClip(report);
    }
    
    function previewReport() {
        const entities = (app.data[app.currentTab] || []).filter(e => !app.disabledEntities[e.val]);
        const sourceIds = app.selectedSources[app.currentTab];
        
        if(entities.length === 0 && sourceIds.length === 0) return toast("No entities or sources to report.", "warning");
        
        const modeSelect = document.getElementById('preview-mode');
        if(entities.length === 0) {
            modeSelect.value = 'simple'; 
            modeSelect.disabled = true;
            modeSelect.title = "Full report requires entities";
        } else {
            modeSelect.disabled = false;
            modeSelect.title = "";
        }
        
        refreshPreview();
        els.modals.preview.classList.add('open');
        syncSettingsUI(); 
    }

    function refreshPreview() {
        const report = buildReportText(true);
        if(!report) {
            document.getElementById('report-content').innerHTML = "No entities to report.";
            return;
        }
        const escaped = report.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const linked = escaped.replace(/###LINK###(.*?)###LINK###/g, '<a href="$1" target="_blank">$1</a>');
        document.getElementById('report-content').innerHTML = linked;
        app.tempReport = buildReportText(false); 
    }

    window.updateVerdict = (ent, key, val) => {
        if(!app.verdicts[ent]) app.verdicts[ent] = { status: 'Untriaged', note: '' };
        app.verdicts[ent][key] = val;
    };
    window.copyToClip = (text, msg = 'Report copied!') => {
        navigator.clipboard.writeText(text).then(() => toast(msg, "success"));
    };
    function toast(msg, type='info') {
        const t = document.getElementById('toast');
        t.innerHTML = `<span>${type === 'error' ? '‚ö†Ô∏è' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}</span> ${msg}`;
        t.className = `toast visible ${type}`;
        setTimeout(() => t.classList.remove('visible'), 3000);
    }

    window.filterManageSources = (cat) => {
        app.manageFilter = cat;
        document.querySelectorAll('.sub-tab').forEach(t => {
            if(t.innerText.toLowerCase() === cat || (cat==='all' && t.innerText==='All')) t.classList.add('active');
            else t.classList.remove('active');
        });
        renderManageSources();
    };

    function renderManageSources() {
        const list = document.getElementById('manage-sources-list');
        list.innerHTML = '';
        let all = [];
        ['ip','domain','hash','bookmarks'].forEach(t => {
            if(window.sources[t]) {
                window.sources[t].forEach(s => {
                    if(!all.find(x => x.id === s.id && x._cat === t)) all.push({...s, _cat: t});
                });
            }
        });
        if(app.manageFilter !== 'all') {
            all = all.filter(x => x._cat === app.manageFilter);
        }
        all.forEach(s => {
            const isFav = app.favorites.includes(s.id);
            const isCustom = app.customSources.find(c => c.id === s.id);
            const div = document.createElement('div');
            div.className = 'ms-item';
            let tags = '';
            if(isCustom) tags += `<span class="ms-tag tag-custom">Custom</span>`;
            if(s.lookupurl) tags += `<span class="ms-tag tag-lookup">Lookup</span>`;
            let displayUrl = s.url;
            let displayLookup = s.lookupurl ? s.lookupurl : '';
            div.innerHTML = `
                <div>
                    <div style="font-weight:600;">${s.name} ${tags}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted); word-break:break-all;">${displayUrl}</div>
                    ${displayLookup ? `<div style="font-size:0.75rem; color:var(--text-muted); word-break:break-all;">${displayLookup}</div>` : ''}
                </div>
                <div class="ms-actions-right">
                    ${isCustom ? `<button class="icon-btn" style="font-size:1rem;" onclick="editCustomSource('${s.id}')">‚úèÔ∏è</button>` : ''}
                    <div class="ms-fav ${isFav ? 'active' : ''}" onclick="toggleFavSetting('${s.id}')">‚ù§Ô∏è</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    window.toggleFavSetting = (id) => {
        if(app.favorites.includes(id)) app.favorites = app.favorites.filter(x => x !== id);
        else app.favorites.push(id);
        saveFavorites();
        renderManageSources();
        if(app.currentTab !== 'overview') renderSources(); 
    };

    window.editCustomSource = (id) => {
        const src = app.customSources.find(s => s.id === id);
        if(!src) return;
        document.getElementById('add-source-form-container').style.display = 'block';
        document.getElementById('add-btn-row').style.display = 'none';
        document.getElementById('delete-custom-source-btn').classList.remove('hidden');
        document.getElementById('delete-custom-source-btn').onclick = () => removeCustomSource(id);
        document.getElementById('cs-id').value = src.id;
        document.getElementById('cs-name').value = src.name;
        document.getElementById('cs-type').value = src.type;
        document.getElementById('cs-home').value = src.url;
        document.getElementById('cs-lookup').value = src.lookupurl;
        document.getElementById('cs-type').onchange();
        document.getElementById('cs-id').disabled = true; 
        document.getElementById('add-source-text').innerText = "Save Changes";
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        app.editingId = id;
    };

    function saveCustomSource() {
        const id = document.getElementById('cs-id').value;
        const name = document.getElementById('cs-name').value;
        const type = document.getElementById('cs-type').value;
        let home = document.getElementById('cs-home').value;
        let lookup = document.getElementById('cs-lookup').value;
        if(!id || !name || !home) return toast("ID, Name, and Home URL required", "error");
        if(home && !home.startsWith('http')) home = 'https://' + home;
        if(lookup && !lookup.startsWith('http')) lookup = 'https://' + lookup;
        if(!app.editingId && app.customSources.find(c => c.id === id)) return toast("ID already exists", "error");
        if(app.editingId) {
            app.customSources = app.customSources.filter(s => s.id !== app.editingId);
        }
        const newSrc = { id, name, type, url: home, lookupurl: lookup || '' };
        app.customSources.push(newSrc);
        localStorage.setItem('totalosint_custom_sources', JSON.stringify(app.customSources));
        if(window.sources[type]) {
            window.sources[type] = window.sources[type].filter(s => s.id !== id);
            window.sources[type].push(newSrc);
        }
        if(!app.favorites.includes(id)) {
            app.favorites.push(id);
            saveFavorites();
        }
        toast(app.editingId ? "Source updated!" : "Source added!", "success");
        renderManageSources();
        closeSourceForm();
        if(app.currentTab === type) renderSources(); 
    }

    function removeCustomSource(id) {
        if(!confirm("Delete this source?")) return;
        if(app.editingId === id) closeSourceForm();
        app.customSources = app.customSources.filter(s => s.id !== id);
        localStorage.setItem('totalosint_custom_sources', JSON.stringify(app.customSources));
        Object.keys(window.sources).forEach(key => {
            window.sources[key] = window.sources[key].filter(s => s.id !== id);
        });
        renderManageSources();
        renderSources();
        toast("Source removed", "warning");
    }

    function closeSourceForm() {
        document.getElementById('add-source-form-container').style.display = 'none';
        document.getElementById('add-btn-row').style.display = 'flex';
        document.getElementById('cs-id').value = '';
        document.getElementById('cs-name').value = '';
        document.getElementById('cs-home').value = '';
        document.getElementById('cs-lookup').value = '';
        document.getElementById('cs-id').disabled = false;
        document.getElementById('add-source-text').innerText = "Save Source";
        document.getElementById('delete-custom-source-btn').classList.add('hidden');
        app.editingId = null;
    }

    window.openBackupUI = () => {
        document.getElementById('backup-ui').style.display = 'block'; 
        document.getElementById('backup-toggle-link').style.display = 'none';
        const backup = { customSources: app.customSources, favorites: app.favorites };
        document.getElementById('backup-text').value = JSON.stringify(backup, null, 2);
    };

    window.closeBackupUI = () => {
        document.getElementById('backup-ui').style.display = 'none'; 
        document.getElementById('backup-toggle-link').style.display = 'inline';
    };

    document.getElementById('btn-do-backup-copy').onclick = () => {
        const txt = document.getElementById('backup-text').value;
        if(txt) copyToClip(txt, "Backup copied!");
    };

    document.getElementById('btn-do-restore').onclick = () => {
        const str = document.getElementById('backup-text').value;
        if(!str.trim()) return toast("Paste JSON first", "error");
        try {
            const backup = JSON.parse(str);
            if(backup.customSources && Array.isArray(backup.customSources)) {
                app.customSources = backup.customSources;
                localStorage.setItem('totalosint_custom_sources', JSON.stringify(app.customSources));
            }
            if(backup.favorites && Array.isArray(backup.favorites)) {
                app.favorites = backup.favorites;
                localStorage.setItem('totalosint_favorites', JSON.stringify(app.favorites));
            }
            toast("Restore successful!", "success");
            init(); 
            softReset(); 
            renderManageSources();
            closeBackupUI();
        } catch(e) {
            toast("Invalid JSON format", "error");
        }
    };

    function toggleReportDropdown() {
        const type = document.getElementById('preview-sep-type').value;
        const disabled = (type === 'newline' || type === 'comma');
        document.getElementById('preview-sep-len').disabled = disabled;
        document.getElementById('preview-sep-len').style.opacity = disabled ? '0.5' : '1';
    }

    function setGlobalDefang(val) {
        app.settings.defang = val;
        saveSettings();
        
        document.getElementById('setting-defang').checked = val;
        document.getElementById('modal-defang').checked = val;
        document.getElementById('preview-defang').checked = val;

        renderOverview();
        if(app.currentTab !== 'overview') renderSources();
        
        if(els.modals.inv.classList.contains('open')) renderInvestigationList();
        if(els.modals.preview.classList.contains('open')) refreshPreview();
    }

    function setupEvents() {
        els.input.addEventListener('input', onInputChanged);
        els.input.addEventListener('scroll', syncScroll);
        
        const resizeObserver = new ResizeObserver(() => {
            if (window.innerWidth > 900 && els.input.style.height) {
                 els.input.style.height = '';
                 els.input.style.width = ''; 
            }
        });
        resizeObserver.observe(document.body);

        document.getElementById('branding-btn').onclick = softReset;
        document.getElementById('clear-input-btn').onclick = softReset;
        document.getElementById('copy-input-btn').onclick = () => copyToClip(els.input.value, 'Notes copied!');

        document.getElementById('select-all-btn').onclick = () => { app.selectedSources[app.currentTab] = window.sources[app.currentTab].map(s => s.id); renderSources(); updateUI(); };
        document.getElementById('deselect-all-btn').onclick = () => { app.selectedSources[app.currentTab] = []; renderSources(); updateUI(); };
        document.getElementById('sort-sources-btn').onclick = () => { app.sortDesc = !app.sortDesc; renderSources(); };
        document.getElementById('manage-sources-btn').onclick = () => { document.querySelector('.modal-tab[data-tab="sources"]').click(); els.modals.settings.classList.add('open'); };

        els.tabs.forEach(t => t.onclick = () => switchTab(t.dataset.type));
        
        document.querySelectorAll('.close-modal').forEach(b => b.onclick = function(e) { 
            e.stopPropagation(); 
            this.closest('.modal-overlay').classList.remove('open');
            closeBackupUI();
        });
        document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', (e) => { 
            if(e.target === m) {
                m.classList.remove('open');
                closeBackupUI();
            }
        }));
        
        document.getElementById('settings-btn').onclick = () => { 
            renderManageSources(); 
            els.modals.settings.classList.add('open'); 
        };
        
        document.getElementById('show-add-form-btn').onclick = () => { 
            document.getElementById('add-source-form-container').style.display = 'block'; 
            document.getElementById('add-btn-row').style.display = 'none';
        };
        document.getElementById('save-custom-source-btn').onclick = saveCustomSource;
        document.getElementById('cancel-edit-btn').onclick = closeSourceForm;
        
        els.launchBtns.modal.onclick = openInvestigation;
        els.launchBtns.direct.onclick = executeInvestigation;
        document.getElementById('execute-btn').onclick = executeInvestigation;
        document.getElementById('generate-report-btn').onclick = generateReport;
        document.getElementById('preview-report-btn').onclick = previewReport;
        document.getElementById('preview-copy-btn').onclick = () => copyToClip(app.tempReport);

        document.querySelectorAll('.modal-tab').forEach(t => t.onclick = function() {
            document.querySelectorAll('.modal-tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(`tab-${this.dataset.tab}`).classList.add('active');
            if(this.dataset.tab === 'sources') renderManageSources();
            closeBackupUI();
        });

        document.getElementById('setting-defang').onchange = (e) => setGlobalDefang(e.target.checked);
        document.getElementById('modal-defang').onchange = (e) => setGlobalDefang(e.target.checked);
        document.getElementById('preview-defang').onchange = (e) => setGlobalDefang(e.target.checked);
        
        ['reference','verdict','sep-type','sep-len','addspace', 'mode', 'quotes', 'list'].forEach(k => {
             const el = document.getElementById(`preview-${k}`);
             if(el) {
                 el.onchange = (e) => {
                     const keyMap = { 
                         'reference':'showReference', 'verdict':'showVerdict', 
                         'sep-type':'sepType', 'sep-len':'sepLen', 'addspace':'addSpace',
                         'mode': 'reportMode', 'quotes': 'quoteType', 'list': 'listType'
                     };
                     const val = (e.target.type === 'checkbox') ? e.target.checked : e.target.value;
                     app.settings[keyMap[k]] = val;
                     syncSettingsUI(); saveSettings();
                     refreshPreview();
                 };
             }
        });

        document.getElementById('cs-id').oninput = function() { this.value = this.value.toUpperCase().replace(/[^A-Z_]/g, ''); };
        
        const typeSelect = document.getElementById('cs-type');
        const lookupInput = document.getElementById('cs-lookup');
        typeSelect.onchange = () => {
            if(typeSelect.value === 'bookmarks') {
                lookupInput.disabled = true; lookupInput.value = ''; lookupInput.placeholder = 'N/A';
            } else {
                lookupInput.disabled = false; lookupInput.placeholder = 'https://tool.com/search?q=';
            }
        };
    }
    
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

